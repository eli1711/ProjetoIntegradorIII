<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cadastro de Aluno</title>
    <link rel="stylesheet" href="css/cadastroAluno.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="js/navbar-protection.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;600;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet" />
  </head>

  <body>
    <header>
      <div class="header-content">
        <div class="logo-container">
          <img src="img/senai-logo.png" class="logo" alt="Logo SENAI" />
          <h1>Sistema de Gestão de Alunos</h1>
        </div>

        <nav>
          <button class="nav-toggle" id="navToggle">
            <i class="fas fa-bars"></i>
          </button>

          <ul id="navMenu">
            <li>
              <a href="./principal.html" class="active"><i class="fas fa-home"></i> Home</a>
            </li>

            <li class="dropdown">
              <a href="#"><i class="fas fa-user-graduate"></i> Alunos <i class="fas fa-chevron-down"></i></a>
              <div class="dropdown-content">
                <a href="./cadastroAluno.html"><i class="fas fa-user-plus"></i> Cadastrar Aluno</a>
                <a href="./consultaAluno.html"><i class="fas fa-search"></i> Consultar Alunos</a>
                <a href="./importar_alunos.html"><i class="fas fa-file-csv"></i> Importar CSV</a>
              </div>
            </li>

            <li><a href="./turmas.html"><i class="fas fa-chalkboard"></i> Turmas</a></li>
            <li><a href="./ocorrencias.html"><i class="fas fa-exclamation-triangle"></i> Ocorrências</a></li>
            <li><a href="./dashboard.html"><i class="fas fa-history"></i> Dashboard</a></li>
            <li><a href="./criar_usuario.html"><i class="fas fa-user-cog"></i> Usuários</a></li>
          </ul>
        </nav>
      </div>
    </header>

    <div class="container">
      <div class="form-container">
        <div class="form-header">
          <h2><i class="fas fa-user-plus"></i> Novo Cadastro de Aluno</h2>
        </div>

        <div class="form-content">
          <div id="alerta" style="display:none;margin-bottom:20px;padding:10px;border-radius:4px;"></div>

          <form id="cadastroAlunoForm" method="POST" enctype="multipart/form-data" action="http://10.110.18.11:5000/alunos/cadastrar">
            <div class="form-section">
              <h3 class="section-title"><i class="fas fa-user"></i> Dados Pessoais</h3>

              <div class="form-grid">
                <div class="form-group">
                  <label for="matricula">Nº de Matrícula: *</label>
                  <input type="text" id="matricula" name="matricula" required />
                </div>

                <div class="form-group">
                  <label for="nome_completo">Nome completo: *</label>
                  <input type="text" id="nome_completo" name="nome_completo" required />
                </div>

                <div class="form-group">
                  <label for="nome_social">Nome Social (opcional):</label>
                  <input type="text" id="nome_social" name="nome_social" />
                </div>

                <div class="form-group">
                  <label for="cpf">CPF: *</label>
                  <input type="text" id="cpf" name="cpf" inputmode="numeric" required placeholder="000.000.000-00" />
                </div>

                <div class="form-group">
                  <label for="data_nascimento">Data de Nascimento: *</label>
                  <input type="date" id="data_nascimento" name="data_nascimento" required />
                </div>

                <div class="form-group">
                  <label for="rua">Endereço (Rua): *</label>
                  <input type="text" id="rua" name="rua" required />
                </div>

                <div class="form-group">
                  <label for="bairro">Bairro: *</label>
                  <input type="text" id="bairro" name="bairro" required />
                </div>

                <div class="form-group">
                  <label for="cidade">Cidade: *</label>
                  <input type="text" id="cidade" name="cidade" required />
                </div>

                <div class="form-group">
                  <label for="telefone">Telefone:</label>
                  <input type="text" id="telefone" name="telefone" inputmode="tel" placeholder="(00) 0000-0000" />
                </div>
              </div>
            </div>

            <div class="form-section">
              <h3 class="section-title"><i class="fas fa-user-friends"></i> Dados do Responsável (se menor)</h3>

              <div id="responsavelSection" class="conditional-section" style="display:none">
                <div class="form-grid">
                  <div class="form-group">
                    <label for="responsavel_nome_completo">Nome completo: *</label>
                    <input type="text" id="responsavel_nome_completo" name="responsavel_nome_completo" />
                  </div>

                  <div class="form-group">
                    <label for="responsavel_parentesco">Parentesco: *</label>
                    <input type="text" id="responsavel_parentesco" name="responsavel_parentesco" />
                  </div>

                  <div class="form-group">
                    <label for="responsavel_telefone">Telefone: *</label>
                    <input type="text" id="responsavel_telefone" name="responsavel_telefone" placeholder="(00) 00000-0000" />
                  </div>

                  <div class="form-group">
                    <label for="responsavel_endereco">Endereço (opcional):</label>
                    <input type="text" id="responsavel_endereco" name="responsavel_endereco" />
                  </div>

                  <div class="form-group">
                    <label for="responsavel_bairro">Bairro (opcional):</label>
                    <input type="text" id="responsavel_bairro" name="responsavel_bairro" />
                  </div>

                  <div class="form-group">
                    <label for="responsavel_cidade">Cidade (opcional):</label>
                    <input type="text" id="responsavel_cidade" name="responsavel_cidade" />
                  </div>
                </div>

                <p class="note">* Campos obrigatórios para alunos menores de 18 anos</p>
              </div>
            </div>

            <div class="form-section">
              <h3 class="section-title"><i class="fas fa-graduation-cap"></i> Dados Acadêmicos</h3>

              <div class="form-grid">
                <div class="form-group">
                  <label for="curso">Curso: *</label>
                  <input type="text" id="curso" name="curso" required />
                </div>

                <div class="form-group">
                  <label for="turma">Turma: *</label>
                  <input type="text" id="turma" name="turma" required />
                </div>

                <div class="form-group">
                  <label for="linha_atendimento">Linha de Atendimento: *</label>
                  <select id="linha_atendimento" name="linha_atendimento" required>
                    <option value="CAI">CAI</option>
                    <option value="CT">CT</option>
                    <option value="CST">CST</option>
                  </select>
                </div>

                <div class="form-group">
                  <label for="escola_integrada">Escola Integrada: *</label>
                  <select id="escola_integrada" name="escola_integrada" required>
                    <option value="Nenhuma">Nenhuma</option>
                    <option value="SESI">SESI</option>
                    <option value="SEDUC">SEDUC</option>
                  </select>
                </div>

                <div class="form-group">
                  <label for="empregado">Empregado? *</label>
                  <select id="empregado" name="empregado" required>
                    <option value="nao" selected>Não</option>
                    <option value="sim">Sim</option>
                  </select>
                </div>

                <div class="form-group">
                  <label for="data_inicio_curso">Data de Início do Curso (opcional):</label>
                  <input type="date" id="data_inicio_curso" name="data_inicio_curso" />
                </div>

                <div class="form-group">
                  <label for="empresa_contratante">Empresa contratante (opcional):</label>
                  <input type="text" id="empresa_contratante" name="empresa_contratante" />
                </div>
              </div>
            </div>

            <div class="form-section">
              <h3 class="section-title"><i class="fas fa-info-circle"></i> Complementares</h3>

              <div class="form-grid">
                <div class="form-group">
                  <div class="checkbox-group">
                    <input type="checkbox" id="pessoa_com_deficiencia" name="pessoa_com_deficiencia" />
                    <label for="pessoa_com_deficiencia">Pessoa com deficiência?</label>
                  </div>
                </div>

                <div class="form-group" style="grid-column: 1/-1;">
                  <label for="sobre_aluno">Sobre o aluno (opcional):</label>
                  <textarea id="sobre_aluno" name="sobre_aluno"></textarea>
                </div>

                <div class="form-group" style="grid-column: 1/-1;">
                  <label for="outras_informacoes">Outras informações (opcional):</label>
                  <textarea id="outras_informacoes" name="outras_informacoes"></textarea>
                </div>

                <div class="form-group">
                  <label for="foto">Foto (opcional):</label>
                  <input type="file" id="foto" name="foto" accept="image/*" />
                </div>
              </div>
            </div>

            <div class="submit-container">
              <button type="submit">
                <i class="fas fa-user-plus"></i> Cadastrar Aluno
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <footer>
      <p>&copy; 2024 Departamento de Qualidade de Vida - Todos os direitos reservados.</p>
    </footer>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const alertaDiv = document.getElementById("alerta");
        const form = document.getElementById("cadastroAlunoForm");

        const nascInput = document.getElementById("data_nascimento");
        const responsavelSection = document.getElementById("responsavelSection");

        const cpfInput = document.getElementById("cpf");

        cpfInput.addEventListener("input", function(e) {
          let value = e.target.value.replace(/\D/g, "");
          if (value.length > 11) value = value.substring(0, 11);

          if (value.length > 9) value = value.replace(/^(\d{3})(\d{3})(\d{3})(\d{2}).*/, "$1.$2.$3-$4");
          else if (value.length > 6) value = value.replace(/^(\d{3})(\d{3})(\d{1,3})/, "$1.$2.$3");
          else if (value.length > 3) value = value.replace(/^(\d{3})(\d{1,3})/, "$1.$2");

          e.target.value = value;
        });

        function showAlert(tipo, mensagem) {
          alertaDiv.style.display = "block";
          alertaDiv.textContent = mensagem;
          if (tipo === "success") {
            alertaDiv.style.backgroundColor = "#d4edda";
            alertaDiv.style.color = "#155724";
            alertaDiv.style.border = "1px solid #c3e6cb";
          } else {
            alertaDiv.style.backgroundColor = "#f8d7da";
            alertaDiv.style.color = "#721c24";
            alertaDiv.style.border = "1px solid #f5c6cb";
          }
          setTimeout(() => (alertaDiv.style.display = "none"), 6000);
        }

        function calcIdade(yyyy_mm_dd) {
          if (!yyyy_mm_dd) return null;
          const [y,m,d] = yyyy_mm_dd.split("-").map(Number);
          if (!y || !m || !d) return null;
          const hoje = new Date();
          let idade = hoje.getFullYear() - y;
          const mm = hoje.getMonth() + 1;
          const dd = hoje.getDate();
          if (mm < m || (mm === m && dd < d)) idade--;
          return idade;
        }

        function toggleResponsavel() {
          const idade = calcIdade(nascInput.value);
          const menor = (idade !== null && idade < 18);
          responsavelSection.style.display = menor ? "block" : "none";

          ["responsavel_nome_completo","responsavel_parentesco","responsavel_telefone"].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.required = menor;
          });
        }

        nascInput.addEventListener("change", toggleResponsavel);
        toggleResponsavel();

        form.addEventListener("submit", async (e) => {
          e.preventDefault();

          const btn = form.querySelector('button[type="submit"]');
          const original = btn.innerHTML;
          btn.disabled = true;
          btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cadastrando...';

          try {
            const fd = new FormData(form);

            // ✅ checkbox -> "true"/"" (backend entende via str_to_bool)
            const pcd = document.getElementById("pessoa_com_deficiencia").checked;
            fd.set("pessoa_com_deficiencia", pcd ? "true" : "false");

            const cpfValue = cpfInput.value.replace(/\D/g, "");
            if (cpfValue.length !== 11) {
              showAlert("error", "CPF deve conter 11 dígitos");
              btn.disabled = false;
              btn.innerHTML = original;
              return;
            }

            const res = await fetch(form.action, { method: "POST", body: fd });
            const data = await res.json();

            if (res.ok) {
              showAlert("success", data.mensagem || "Aluno cadastrado com sucesso!");
              form.reset();
              toggleResponsavel();
            } else {
              showAlert("error", data.erro || "Erro no cadastro");
            }
          } catch (err) {
            console.error(err);
            showAlert("error", "Erro inesperado ao enviar o formulário.");
          } finally {
            btn.disabled = false;
            btn.innerHTML = original;
          }
        });
      });
    </script>
  </body>
</html>
