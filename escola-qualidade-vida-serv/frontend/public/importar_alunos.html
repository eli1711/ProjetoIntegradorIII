<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Importar Alunos (CSV)</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="./css/importarAlunos.css" />
  </head>
  <body>
    <header>
      <div class="header-content">
        <div class="logo-container">
          <img src="img/senai-logo.png" class="logo" alt="Logo SENAI" />
          <h1>Sistema de Gestão de Alunos</h1>
        </div>
        <nav>
          <button class="nav-toggle" id="navToggle">
            <i class="fas fa-bars"></i>
          </button>
          <ul id="navMenu">
            <li>
              <a href="./principal.html" class="active"
                ><i class="fas fa-home"></i> Home</a
              >
            </li>
            <li class="dropdown">
              <a href="#"
                ><i class="fas fa-user-graduate"></i> Alunos
                <i class="fas fa-chevron-down"></i
              ></a>
              <div class="dropdown-content">
                <a href="./cadastroAluno.html"
                  ><i class="fas fa-user-plus"></i> Cadastrar Aluno</a
                >
                <a href="./consultaAluno.html"
                  ><i class="fas fa-search"></i> Consultar Alunos</a
                >
                <a href="./importar_alunos.html"
                  ><i class="fas fa-file-csv"></i> Importar CSV</a
                >
              </div>
            </li>
            <li>
              <a href="./turmas.html"
                ><i class="fas fa-chalkboard"></i> Turmas</a
              >
            </li>
            <li>
              <a href="./ocorrencias.html"
                ><i class="fas fa-exclamation-triangle"></i> Ocorrências</a
              >
            </li>
            <li>
              <a href="./dashboard.html"
                ><i class="fas fa-chart-pie"></i> Ocorrências</a
              >
            </li>
            <li>
              <a href="./criar_usuario.html"
                ><i class="fas fa-user-cog"></i> Usuários</a
              >
            </li>
          </ul>
        </nav>
      </div>
    </header>

    <div class="container">
      <div class="form-container">
        <div class="form-header">
          <h2><i class="fa-solid fa-file-csv"></i> Importar Alunos (CSV)</h2>
        </div>
        <div class="form-content">
          <div id="alerta"></div>

          <div class="form-section">
            <h3 class="section-title">
              <i class="fas fa-info-circle"></i> Instruções de Importação
            </h3>
            <div class="card1">
              <p class="note">
                Faça o upload de um arquivo CSV com os seguintes cabeçalhos
                (ordem livre).<br />
                <strong>Observações importantes:</strong><br />
                1. <code>cpf</code> é obrigatório e deve ter 11 dígitos (aceita
                formatação: 123.456.789-00)<br />
                2. <code>idade</code> pode ser informada ou será calculada
                automaticamente da data de nascimento<br />
                3. <code>data de nascimento</code> formato: YYYY-MM-DD ou
                DD/MM/YYYY<br />
                4. <strong>Responsável:</strong> se o aluno for menor (idade
                &lt; 18), os campos do responsável são obrigatórios<br />
                5. <code>pessoa com deficiencia</code> aceita: true/false, 1/0,
                sim/nao<br />
                6. <code>linha atendimento</code> deve ser: CAI, CT ou CST<br />
                7. <code>escola integrada</code> deve ser: SESI, SEDUC ou
                Nenhuma<br />
                8. <code>empregado</code> deve ser: sim ou nao
              </p>

              <div class="card2">
                <table>
                  <thead>
                    <tr>
                      <th>Campo</th>
                      <th>Obrigatório?</th>
                      <th>Observações</th>
                    </tr>
                  </thead>
                  <tbody>
                    <!-- ===== CAMPOS OBRIGATÓRIOS ===== -->
                    <tr>
                      <td>matricula</td>
                      <td><strong>SIM</strong></td>
                      <td>Número de matrícula único</td>
                    </tr>
                    <tr>
                      <td>nome completo</td>
                      <td><strong>SIM</strong></td>
                      <td>Nome completo do aluno</td>
                    </tr>
                    <tr>
                      <td>cpf</td>
                      <td><strong>SIM</strong></td>
                      <td>11 dígitos (pode vir com pontuação)</td>
                    </tr>
                    <tr>
                      <td>data nascimento</td>
                      <td><strong>SIM</strong></td>
                      <td>YYYY-MM-DD ou DD/MM/YYYY</td>
                    </tr>
                    <tr>
                      <td>cidade</td>
                      <td><strong>SIM</strong></td>
                      <td>Cidade do aluno</td>
                    </tr>
                    <tr>
                      <td>bairro</td>
                      <td><strong>SIM</strong></td>
                      <td>Bairro do aluno</td>
                    </tr>
                    <tr>
                      <td>rua</td>
                      <td><strong>SIM</strong></td>
                      <td>Endereço completo (rua, número)</td>
                    </tr>
                    <tr>
                      <td>curso</td>
                      <td><strong>SIM</strong></td>
                      <td>Nome do curso</td>
                    </tr>
                    <tr>
                      <td>turma</td>
                      <td><strong>SIM</strong></td>
                      <td>Turma do aluno</td>
                    </tr>
                    <tr>
                      <td>idade</td>
                      <td><strong>SIM</strong></td>
                      <td>Idade (pode calcular automaticamente)</td>
                    </tr>
                    <tr>
                      <td>empregado</td>
                      <td><strong>SIM</strong></td>
                      <td>sim ou nao</td>
                    </tr>
                    <tr>
                      <td>linha atendimento</td>
                      <td><strong>SIM</strong></td>
                      <td>CAI, CT ou CST</td>
                    </tr>
                    <tr>
                      <td>escola ntegrada</td>
                      <td><strong>SIM</strong></td>
                      <td>SESI, SEDUC ou Nenhuma</td>
                    </tr>

                    <!-- ===== CAMPOS OPCIONAIS ===== -->
                    <tr>
                      <td>telefone</td>
                      <td>NÃO</td>
                      <td>Telefone fixo</td>
                    </tr>
                    <tr>
                      <td>mora com quem</td>
                      <td>NÃO</td>
                      <td>Com quem mora</td>
                    </tr>
                    <tr>
                      <td>sobre aluno</td>
                      <td>NÃO</td>
                      <td>Observações sobre o aluno</td>
                    </tr>
                    <tr>
                      <td>data inicio curso</td>
                      <td>NÃO</td>
                      <td>Data de início do curso</td>
                    </tr>
                    <tr>
                      <td>empresa contratante</td>
                      <td>NÃO</td>
                      <td>Empresa do contrato de aprendizagem</td>
                    </tr>
                    <tr>
                      <td>pessoa com deficiencia</td>
                      <td>NÃO</td>
                      <td>true/false (PNE)</td>
                    </tr>
                    <tr>
                      <td>outras informacoes</td>
                      <td>NÃO</td>
                      <td>Informações adicionais</td>
                    </tr>

                    <!-- ===== RESPONSÁVEL (se menor) ===== -->
                    <tr>
                      <td
                        colspan="3"
                        style="background: #d5d8db; text-align: center"
                      >
                        <strong
                          >CAMPOS DO RESPONSÁVEL (obrigatórios se idade &lt;
                          18)</strong
                        >
                      </td>
                    </tr>
                    <tr>
                      <td>responsavel nome completo</td>
                      <td>NÃO</td>
                      <td>Nome completo do responsável</td>
                    </tr>
                    <tr>
                      <td>responsavel parentesco</td>
                      <td>NÃO</td>
                      <td>Parentesco com o aluno</td>
                    </tr>
                    <tr>
                      <td>responsavel telefone</td>
                      <td>NÃO</td>
                      <td>Telefone do responsável</td>
                    </tr>
                    <tr>
                      <td>responsavel cidade</td>
                      <td>NÃO</td>
                      <td>Cidade do responsável</td>
                    </tr>
                    <tr>
                      <td>responsavel bairro</td>
                      <td>NÃO</td>
                      <td>Bairro do responsável</td>
                    </tr>
                    <tr>
                      <td>responsavel endereco</td>
                      <td>NÃO</td>
                      <td>Endereço do responsável</td>
                    </tr>
                  </tbody>
                </table>

                <p class="note" style="margin-top: 1rem">
                  <strong>Baixe um modelo pronto:</strong>
                  <a
                    class="template-link"
                    href="http://10.110.18.11:5000/alunos/csv_modelo"
                    target="_blank"
                  >
                    <i class="fa-regular fa-file"></i> CSV Modelo (Atualizado)
                  </a>
                </p>
              </div>
            </div>
          </div>

          <div class="form-section">
            <h3 class="section-title">
              <i class="fas fa-upload"></i> Upload do Arquivo
            </h3>
            <div class="form-grid">
              <div class="form-group">
                <label for="arquivo">Arquivo CSV:</label>
                <input type="file" id="arquivo" accept=".csv" />
              </div>
            </div>

            <div class="submit-container">
              <button id="btnImportar">
                <i class="fas fa-cloud-upload-alt"></i> Importar CSV
              </button>
            </div>
          </div>

          <div class="form-section" id="resultado" style="display: none">
            <h3 class="section-title">
              <i class="fas fa-clipboard-list"></i> Relatório de Importação
            </h3>
            <div class="card">
              <pre id="log"></pre>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer>
      <p>
        &copy; 2024 Departamento de Qualidade de Vida - Todos os direitos
        reservados.
      </p>
    </footer>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const fileInput = document.getElementById("arquivo");
        const btn = document.getElementById("btnImportar");
        const alertaDiv = document.getElementById("alerta");
        const resultado = document.getElementById("resultado");
        const logEl = document.getElementById("log");

        function showAlert(tipo, msg) {
          alertaDiv.style.display = "block";
          alertaDiv.className =
            tipo === "success" ? "alert-success" : "alert-error";
          alertaDiv.textContent = msg;
          setTimeout(() => (alertaDiv.style.display = "none"), 7000);
        }

        btn.addEventListener("click", async () => {
          if (!fileInput.files.length) {
            showAlert("error", "Selecione um arquivo CSV.");
            return;
          }

          const fd = new FormData();
          fd.append("arquivo", fileInput.files[0]);

          btn.disabled = true;
          const original = btn.innerHTML;
          btn.innerHTML =
            '<i class="fa-solid fa-spinner fa-spin"></i> Importando...';

          try {
            const res = await fetch(
              "http://10.110.18.11:5000/alunos/importar_csv",
              {
                method: "POST",
                body: fd,
              }
            );
            const data = await res.json();

            if (res.ok) {
              showAlert(
                "success",
                `Importação finalizada: ${data.sucesso} alunos inseridos, ${data.pulos} pulos, ${data.erros} erros.`
              );
            } else {
              let errorMsg = data.erro || "Falha na importação.";
              if (data.faltando) {
                errorMsg += ` Faltando campos: ${data.faltando.join(", ")}`;
              }
              showAlert("error", errorMsg);
            }

            resultado.style.display = "block";
            if (data.relatorio && Array.isArray(data.relatorio)) {
              logEl.textContent = data.relatorio.join("\n");
            } else if (data.relatorio) {
              logEl.textContent = String(data.relatorio);
            } else {
              logEl.textContent = "Sem mensagens no relatório.";
            }
          } catch (e) {
            console.error(e);
            showAlert("error", "Erro de comunicação com o servidor.");
          } finally {
            btn.disabled = false;
            btn.innerHTML =
              '<i class="fas fa-cloud-upload-alt"></i> Importar CSV';
          }
        });

        // Adicionar link para download do modelo
        const templateLink = document.querySelector(".template-link");
        if (templateLink) {
          templateLink.addEventListener("click", (e) => {
            e.preventDefault();
            window.open("http://10.110.18.11:5000/alunos/csv_modelo", "_blank");
          });
        }
      });
    </script>
  </body>
</html>
