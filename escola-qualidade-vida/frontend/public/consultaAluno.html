<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Consulta de Alunos</title>
  <link rel="stylesheet" href="./css/cadastroAluno.css">
  <style>
    /* Estilo aprimorado para cards */
    .aluno-card {
      display: flex;
      align-items: flex-start;
      gap: 20px;
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
      background: #fff;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    }
    .aluno-card img {
      width: 120px;
      height: 120px;
      border-radius: 8px;
      object-fit: cover;
      border: 2px solid #eee;
    }
    .aluno-card .info { flex: 1; }
    .aluno-card h3 { margin-bottom: 10px; color: #a80000; }
    .aluno-card p { margin: 3px 0; font-size: 0.95rem; }

    #filtros {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 25px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    }
    #consultarButton {
      background-color: #a80000;
      color: #fff;
      border: none;
      padding: 10px 18px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }
    #consultarButton:hover { background-color: #c70000; }

    details summary {
      cursor: pointer;
      font-weight: bold;
      color: #333;
      margin-top: 8px;
    }
    details p { margin-left: 15px; }
  </style>
</head>

<body>
  <header>
    <h1>Consulta de Alunos</h1>
    <nav>
      <ul>
        <li><a href="./principal.html">Home</a></li>
        <li><a href="./cadastroAluno.html">Cadastrar</a></li>
        <li><a href="./ocorrencias.html">OcorrÃªncias</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <section id="filtros">
      <h3>Filtros de Busca</h3>
      <label for="alunoNome">Nome do Aluno:</label>
      <input type="text" id="alunoNome" placeholder="Digite o nome do aluno">
      <button id="consultarButton">Consultar</button>
    </section>

    <section id="resultadoConsulta" style="margin-top: 20px;"></section>
  </main>

  <script>
    const resultadoDiv = document.getElementById("resultadoConsulta");
    const btn = document.getElementById("consultarButton");

    function safe(val, fallback = "NÃ£o informado") {
      if (val === null || val === undefined || val === "") return fallback;
      return val;
    }

    function boolLabel(v) {
      if (typeof v === "boolean") return v ? "Sim" : "NÃ£o";
      // se vier "t"/"f" do Postgres, ou "sim"/"nao"
      const s = String(v || "").toLowerCase();
      if (["t", "true", "1", "sim", "yes", "y"].includes(s)) return "Sim";
      if (["f", "false", "0", "nao", "nÃ£o", "no", "n"].includes(s)) return "NÃ£o";
      return safe(v);
    }

    btn.addEventListener("click", async () => {
      const nome = document.getElementById("alunoNome").value.trim();
      const url = new URL("http://localhost:5000/alunos/buscar");
      if (nome) url.searchParams.append("nome", nome);

      resultadoDiv.innerHTML = "<p>Carregando...</p>";

      try {
        const response = await fetch(url);
        const data = await response.json();
        resultadoDiv.innerHTML = "";

        if (response.ok && Array.isArray(data) && data.length > 0) {
          data.forEach(aluno => {
            // monta a turma priorizando o relacionamento real
            const turmaRotulo = aluno.turma_nome
              ? `${aluno.turma_nome}${aluno.turma_semestre ? ` (Sem ${aluno.turma_semestre})` : ""}`
              : (aluno.turma || "NÃ£o informada");

            const card = document.createElement("div");
            card.classList.add("aluno-card");

            const fotoHtml = aluno.foto_url
              ? `<img src="${aluno.foto_url}" alt="Foto de ${safe(aluno.nome, "Aluno")}">`
              : `<div style="width:120px;height:120px;border-radius:8px;background:#eee;display:flex;align-items:center;justify-content:center;color:#777;">Sem Foto</div>`;

            card.innerHTML = `
              ${fotoHtml}
              <div class="info">
                <h3>${safe(aluno.nome)}</h3>
                <p><strong>ID:</strong> ${safe(aluno.id)}</p>
                <p><strong>MatrÃ­cula:</strong> ${safe(aluno.matricula)}</p>
                <p><strong>Curso:</strong> ${safe(aluno.curso)}</p>
                <p><strong>Turma:</strong> ${safe(turmaRotulo)}</p>
                <p><strong>Cidade:</strong> ${safe(aluno.cidade)}</p>
                <p><strong>Bairro:</strong> ${safe(aluno.bairro)}</p>
                <p><strong>Rua:</strong> ${safe(aluno.rua)}</p>
                <p><strong>Telefone:</strong> ${safe(aluno.telefone)}</p>
                <p><strong>Idade:</strong> ${safe(aluno.idade)}</p>
                <p><strong>Data de Nascimento:</strong> ${safe(aluno.data_nascimento)}</p>
                <p><strong>Linha de Atendimento:</strong> ${safe(aluno.linha_atendimento)}</p>
                <p><strong>Escola Integrada:</strong> ${safe(aluno.escola_integrada)}</p>
                <p><strong>Empresa Contratante:</strong> ${safe(aluno.empresa_contratante)}</p>
                <p><strong>Data de InÃ­cio do Curso:</strong> ${safe(aluno.data_inicio_curso)}</p>
                <p><strong>Mora com quem:</strong> ${safe(aluno.mora_com_quem)}</p>
                <p><strong>Sobre o Aluno:</strong> ${safe(aluno.sobre_aluno)}</p>
                <p><strong>Pessoa com DeficiÃªncia:</strong> ${boolLabel(aluno.pessoa_com_deficiencia)}</p>
                <p><strong>Outras InformaÃ§Ãµes:</strong> ${safe(aluno.outras_informacoes)}</p>

                <details>
                  <summary><strong>OcorrÃªncias (${aluno.ocorrencias?.length || 0})</strong></summary>
                  ${
                    aluno.ocorrencias && aluno.ocorrencias.length > 0
                      ? aluno.ocorrencias.map(oc =>
                          `<p>ðŸ“… ${safe(oc.data_ocorrencia)} â€” <strong>${safe(oc.tipo)}</strong>: ${safe(oc.descricao)}</p>`
                        ).join("")
                      : "<p>Sem ocorrÃªncias registradas.</p>"
                  }
                </details>
              </div>
            `;
            resultadoDiv.appendChild(card);
          });
        } else {
          resultadoDiv.innerHTML = "<p style='color:#a00;'>Nenhum aluno encontrado.</p>";
        }
      } catch (err) {
        console.error(err);
        resultadoDiv.innerHTML = "<p style='color:red;'>Erro ao consultar alunos.</p>";
      }
    });
  </script>
</body>
</html>
