<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - Histórico e Indicadores</title>
  <link rel="stylesheet" href="./css/dashboard.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&family=Poppins:wght@500;600&display=swap" rel="stylesheet" />
  <style>
    /* Estilos adicionais para o dashboard */
    .sem-dados {
      text-align: center;
      padding: 40px;
      color: #666;
      font-style: italic;
      background: #f9f9f9;
      border-radius: 8px;
      margin: 10px;
    }
    
    .zebrado {
      background-color: #f9f9f9;
    }
    
    .btn-limpar {
      background-color: #6c757d;
      color: white;
    }
    
    .btn-limpar:hover {
      background-color: #5a6268;
    }
    
    .btn-teste {
      background-color: #28a745;
      color: white;
    }
    
    .btn-teste:hover {
      background-color: #218838;
    }
    
    .table-container {
      overflow-x: auto;
      margin-top: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    #tabelaAlunos {
      width: 100%;
      border-collapse: collapse;
      min-width: 800px;
    }
    
    #tabelaAlunos th {
      background-color: #4a6fa5;
      color: white;
      padding: 12px 15px;
      text-align: left;
      font-weight: 600;
    }
    
    #tabelaAlunos td {
      padding: 12px 15px;
      border-bottom: 1px solid #ddd;
    }
    
    #tabelaAlunos tr:hover {
      background-color: #f5f5f5;
    }
    
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .chart-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      min-height: 300px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .kpis {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .kpi {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      text-align: center;
    }
    
    .kpi h3 {
      margin: 0 0 10px 0;
      color: #555;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .kpi .value {
      font-size: 32px;
      font-weight: 700;
      color: #4a6fa5;
    }
    
    .filters {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    
    .group {
      display: flex;
      flex-direction: column;
    }
    
    .group label {
      margin-bottom: 5px;
      font-weight: 600;
      color: #555;
    }
    
    .group select,
    .group input {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    
    .btn {
      padding: 10px 20px;
      background-color: #4a6fa5;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: background-color 0.3s;
      margin-top: 23px;
    }
    
    .btn:hover {
      background-color: #3a5a80;
    }
    
    .section {
      margin-bottom: 40px;
    }
    
    .section h2 {
      color: #333;
      border-bottom: 2px solid #4a6fa5;
      padding-bottom: 10px;
      margin-bottom: 20px;
    }
    
    body {
      font-family: 'Open Sans', sans-serif;
      background-color: #f5f7fa;
      color: #333;
      margin: 0;
      padding: 20px;
    }
    
    main {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .loading {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
    
    .loading.active {
      display: flex;
    }
    
    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #4a6fa5;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .aviso {
      background-color: #fff3cd;
      border: 1px solid #ffeaa7;
      color: #856404;
      padding: 12px 15px;
      border-radius: 4px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .aviso.erro {
      background-color: #f8d7da;
      border-color: #f5c6cb;
      color: #721c24;
    }
    
    .aviso.sucesso {
      background-color: #d4edda;
      border-color: #c3e6cb;
      color: #155724;
    }
  </style>
</head>
<body>
  <!-- Loading overlay -->
  <div id="loadingOverlay" class="loading">
    <div class="spinner"></div>
    <p>Carregando dados do dashboard...</p>
  </div>

  <main>
    <!-- Área para avisos -->
    <div id="areaAvisos"></div>

    <!-- Filtros -->
    <section class="filters">
      <div class="group">
        <label for="statusTurma">Status da Turma</label>
        <select id="statusTurma">
          <option value="todas">Todas</option>
          <option value="ativas" selected>Ativas</option>
          <option value="finalizadas">Finalizadas</option>
        </select>
      </div>
      <div class="group">
        <label for="cursoFiltro">Curso</label>
        <select id="cursoFiltro">
          <option value="">Todos os Cursos</option>
        </select>
      </div>
      <div class="group">
        <label for="buscaAluno">Buscar Aluno</label>
        <input type="text" id="buscaAluno" placeholder="Nome do aluno" />
      </div>
      <div class="group">
        <label for="buscaTurma">Buscar Turma</label>
        <input type="text" id="buscaTurma" placeholder="Nome da turma" />
      </div>
      <div class="group">
        <button id="btnAplicar" class="btn">
          <i class="fa-solid fa-filter"></i> Aplicar
        </button>
      </div>
      <div class="group">
        <button id="btnLimpar" class="btn btn-limpar">
          <i class="fa-solid fa-eraser"></i> Limpar
        </button>
      </div>
      <div class="group">
        <button id="btnTeste" class="btn btn-teste">
          <i class="fa-solid fa-bug"></i> Testar
        </button>
      </div>
    </section>

    <!-- Indicadores Gerais -->
    <section class="section">
      <h2>Indicadores Gerais</h2>
      <div class="kpis">
        <div class="kpi">
          <h3>Total de Alunos</h3>
          <div class="value" id="kpiTotalAlunos">-</div>
        </div>
        <div class="kpi">
          <h3>Alunos PCD</h3>
          <div class="value" id="kpiPCD">-</div>
        </div>
        <div class="kpi">
          <h3>Média de Idade</h3>
          <div class="value" id="kpiMediaIdade">-</div>
        </div>
        <div class="kpi">
          <h3>Turmas Ativas</h3>
          <div class="value" id="kpiTurmasAtivas">-</div>
        </div>
        <div class="kpi">
          <h3>Turmas Finalizadas</h3>
          <div class="value" id="kpiTurmasFinalizadas">-</div>
        </div>
        <div class="kpi">
          <h3>Total Ocorrências</h3>
          <div class="value" id="kpiOcorrencias">-</div>
        </div>
      </div>
    </section>

    <!-- Visão Gráfica -->
    <section class="section">
      <h2>Visão Gráfica</h2>
      <div class="charts-grid">
        <div class="chart-card">
          <canvas id="chartAlunosCurso"></canvas>
        </div>
        <div class="chart-card">
          <canvas id="chartOcorrenciasCurso"></canvas>
        </div>
        <div class="chart-card">
          <canvas id="chartEscolas"></canvas>
        </div>
      </div>
    </section>

    <!-- Lista de Alunos -->
    <section class="section">
      <h2>Lista de Alunos</h2>
      <div class="table-container">
        <table id="tabelaAlunos">
          <thead>
            <tr>
              <th>ID</th>
              <th>Nome</th>
              <th>Turma</th>
              <th>Curso</th>
              <th>Idade</th>
              <th>Escola Integrada</th>
              <th>PCD</th>
              <th>Ocorrências</th>
            </tr>
          </thead>
          <tbody id="corpoTabelaAlunos">
            <!-- Dados serão inseridos aqui via JavaScript -->
            <tr>
              <td colspan="8" style="text-align: center; padding: 30px; color: #666;">
                Carregando dados do dashboard...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- JavaScript do Dashboard EMBUTIDO -->
  <script>
    // dashboard-charts.js - CÓDIGO COMPLETO EMBUTIDO
    
    // Variáveis globais para os gráficos
    let chartAlunosCurso = null;
    let chartOcorrenciasCurso = null;
    let chartEscolas = null;

    // Carregar dados do dashboard
    // NO dashboard.html - APENAS a função carregarDashboard atualizada:
async function carregarDashboard() {
  try {
    mostrarCarregamento(true);
    limparAvisos();
    
    console.log('Buscando dados do dashboard...');
    
    // URL SIMPLES - sem parâmetros inicialmente
    const url = 'http://localhost:5000/dashboard';
    
    const response = await fetch(url);
    
    if (!response.ok) {
      throw new Error(`Erro ${response.status}: ${response.statusText}`);
    }
    
    const dados = await response.json();
    console.log('Dados recebidos:', dados);
    
    // Atualizar KPIs
    atualizarKPIs(dados);
    
    // Renderizar gráficos
    if (dados.graficos) {
      renderizarGraficos(dados.graficos);
    }
    
    // Renderizar tabela de alunos
    if (dados.alunosFiltrados) {
      renderizarTabelaAlunos(dados.alunosFiltrados);
      
      // Mostrar mensagem se nenhum aluno
      if (dados.alunosFiltrados.length === 0) {
        mostrarAviso('Nenhum aluno encontrado no sistema.', 'info');
      } else {
        mostrarAviso(`Carregados ${dados.alunosFiltrados.length} alunos`, 'sucesso');
      }
    }
    
    if (dados.mensagem) {
      mostrarAviso(dados.mensagem, 'info');
    }
    
  } catch (error) {
    console.error('Erro ao carregar dashboard:', error);
    mostrarAviso(`Erro: ${error.message}`, 'erro');
    
    // Mostrar mensagem de erro na tabela
    const tbody = document.getElementById('corpoTabelaAlunos');
    if (tbody) {
      tbody.innerHTML = '';
      const row = tbody.insertRow();
      const cell = row.insertCell();
      cell.colSpan = 8;
      cell.innerHTML = `
        <div style="text-align: center; padding: 30px; color: #666;">
          <i class="fas fa-exclamation-triangle" style="font-size: 36px; margin-bottom: 15px; color: #dc3545;"></i>
          <h4 style="margin: 0 0 10px 0;">Não foi possível carregar os dados</h4>
          <p style="margin: 0 0 15px 0;">${error.message}</p>
          <button onclick="location.reload()" class="btn" style="background-color: #dc3545;">
            <i class="fas fa-redo"></i> Recarregar página
          </button>
        </div>
      `;
    }
    
  } finally {
    mostrarCarregamento(false);
  }
}

    // Atualizar KPIs
    function atualizarKPIs(dados) {
      // Função auxiliar para formatar números
      const formatarNumero = (valor) => {
        if (valor === undefined || valor === null) return '-';
        if (valor === 0) return '0';
        return Number.isInteger(valor) ? valor.toString() : valor.toFixed(1);
      };
      
      // Atualizar cada KPI
      document.getElementById('kpiTotalAlunos').textContent = formatarNumero(dados.totalAlunos);
      document.getElementById('kpiPCD').textContent = formatarNumero(dados.alunosPCD);
      document.getElementById('kpiMediaIdade').textContent = formatarNumero(dados.mediaIdade);
      document.getElementById('kpiTurmasAtivas').textContent = formatarNumero(dados.turmasAtivas);
      document.getElementById('kpiTurmasFinalizadas').textContent = formatarNumero(dados.turmasFinalizadas);
      document.getElementById('kpiOcorrencias').textContent = formatarNumero(dados.totalOcorrencias);
    }

    // Renderizar gráficos
    function renderizarGraficos(graficos) {
      // Destruir gráficos existentes
      if (chartAlunosCurso) chartAlunosCurso.destroy();
      if (chartOcorrenciasCurso) chartOcorrenciasCurso.destroy();
      if (chartEscolas) chartEscolas.destroy();
      
      // Gráfico 1: Alunos por Curso
      const ctx1 = document.getElementById('chartAlunosCurso');
      if (ctx1) {
        const cursos = Object.keys(graficos.alunosPorCurso || {});
        const valoresCursos = Object.values(graficos.alunosPorCurso || {});
        
        // Se não houver dados, mostrar mensagem
        if (cursos.length === 0) {
          ctx1.style.display = 'none';
          const parent = ctx1.parentElement;
          const semDados = parent.querySelector('.sem-dados');
          if (!semDados) {
            parent.innerHTML += '<p class="sem-dados">Nenhum dado disponível para alunos por curso</p>';
          }
        } else {
          ctx1.style.display = 'block';
          // Remover mensagem de sem dados se existir
          const semDados = ctx1.parentElement.querySelector('.sem-dados');
          if (semDados) semDados.remove();
          
          chartAlunosCurso = new Chart(ctx1.getContext('2d'), {
            type: 'bar',
            data: {
              labels: cursos,
              datasets: [{
                label: 'Alunos por Curso',
                data: valoresCursos,
                backgroundColor: 'rgba(74, 111, 165, 0.6)',
                borderColor: 'rgba(74, 111, 165, 1)',
                borderWidth: 2,
                borderRadius: 5
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: {
                  display: true,
                  position: 'top'
                },
                title: {
                  display: true,
                  text: 'Distribuição de Alunos por Curso'
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  title: {
                    display: true,
                    text: 'Número de Alunos'
                  }
                },
                x: {
                  title: {
                    display: true,
                    text: 'Cursos'
                  }
                }
              }
            }
          });
        }
      }
      
      // Gráfico 2: Ocorrências por Tipo
      const ctx2 = document.getElementById('chartOcorrenciasCurso');
      if (ctx2) {
        const tipos = Object.keys(graficos.ocorrenciasPorTipo || {});
        const valoresTipos = Object.values(graficos.ocorrenciasPorTipo || {});
        
        // Se não houver dados, mostrar mensagem
        if (tipos.length === 0) {
          ctx2.style.display = 'none';
          const parent = ctx2.parentElement;
          const semDados = parent.querySelector('.sem-dados');
          if (!semDados) {
            parent.innerHTML += '<p class="sem-dados">Nenhuma ocorrência registrada</p>';
          }
        } else {
          ctx2.style.display = 'block';
          // Remover mensagem de sem dados se existir
          const semDados = ctx2.parentElement.querySelector('.sem-dados');
          if (semDados) semDados.remove();
          
          chartOcorrenciasCurso = new Chart(ctx2.getContext('2d'), {
            type: 'pie',
            data: {
              labels: tipos,
              datasets: [{
                label: 'Ocorrências por Tipo',
                data: valoresTipos,
                backgroundColor: [
                  'rgba(255, 99, 132, 0.6)',
                  'rgba(54, 162, 235, 0.6)',
                  'rgba(255, 206, 86, 0.6)',
                  'rgba(75, 192, 192, 0.6)',
                  'rgba(153, 102, 255, 0.6)',
                  'rgba(255, 159, 64, 0.6)',
                  'rgba(201, 203, 207, 0.6)'
                ],
                borderColor: [
                  'rgba(255, 99, 132, 1)',
                  'rgba(54, 162, 235, 1)',
                  'rgba(255, 206, 86, 1)',
                  'rgba(75, 192, 192, 1)',
                  'rgba(153, 102, 255, 1)',
                  'rgba(255, 159, 64, 1)',
                  'rgba(201, 203, 207, 1)'
                ],
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: {
                  position: 'right'
                },
                title: {
                  display: true,
                  text: 'Distribuição de Ocorrências por Tipo'
                }
              }
            }
          });
        }
      }
      
      // Gráfico 3: Escolas Integradas
      const ctx3 = document.getElementById('chartEscolas');
      if (ctx3) {
        const escolas = Object.keys(graficos.escolas || {});
        const valoresEscolas = Object.values(graficos.escolas || {});
        
        // Se não houver dados, mostrar mensagem
        if (escolas.length === 0) {
          ctx3.style.display = 'none';
          const parent = ctx3.parentElement;
          const semDados = parent.querySelector('.sem-dados');
          if (!semDados) {
            parent.innerHTML += '<p class="sem-dados">Nenhum dado disponível para escolas</p>';
          }
        } else {
          ctx3.style.display = 'block';
          // Remover mensagem de sem dados se existir
          const semDados = ctx3.parentElement.querySelector('.sem-dados');
          if (semDados) semDados.remove();
          
          chartEscolas = new Chart(ctx3.getContext('2d'), {
            type: 'doughnut',
            data: {
              labels: escolas,
              datasets: [{
                label: 'Escolas Integradas',
                data: valoresEscolas,
                backgroundColor: [
                  'rgba(255, 159, 64, 0.6)',
                  'rgba(201, 203, 207, 0.6)',
                  'rgba(75, 192, 192, 0.6)',
                  'rgba(54, 162, 235, 0.6)',
                  'rgba(153, 102, 255, 0.6)'
                ],
                borderColor: [
                  'rgba(255, 159, 64, 1)',
                  'rgba(201, 203, 207, 1)',
                  'rgba(75, 192, 192, 1)',
                  'rgba(54, 162, 235, 1)',
                  'rgba(153, 102, 255, 1)'
                ],
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: {
                  position: 'right'
                },
                title: {
                  display: true,
                  text: 'Distribuição por Escola Integrada'
                }
              }
            }
          });
        }
      }
    }

    // Renderizar tabela de alunos
    function renderizarTabelaAlunos(alunos) {
      const tbody = document.getElementById('corpoTabelaAlunos');
      if (!tbody) {
        console.error('Elemento corpoTabelaAlunos não encontrado');
        return;
      }
      
      // Limpar tabela existente
      tbody.innerHTML = '';
      
      // Se não houver alunos
      if (!alunos || alunos.length === 0) {
        const row = tbody.insertRow();
        const cell = row.insertCell();
        cell.colSpan = 8;
        cell.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #666;">
            <i class="fas fa-user-slash" style="font-size: 48px; margin-bottom: 20px; opacity: 0.3;"></i>
            <h3 style="margin: 0 0 10px 0;">Nenhum aluno encontrado</h3>
            <p style="margin: 0;">Tente ajustar os filtros de busca</p>
          </div>
        `;
        return;
      }
      
      // Adicionar cada aluno na tabela
      alunos.forEach((aluno, index) => {
        const row = tbody.insertRow();
        
        // ID
        const cellId = row.insertCell();
        cellId.textContent = aluno.id || '-';
        
        // Nome
        const cellNome = row.insertCell();
        cellNome.textContent = aluno.nome || '-';
        
        // Turma
        const cellTurma = row.insertCell();
        cellTurma.textContent = aluno.turma || '-';
        
        // Curso
        const cellCurso = row.insertCell();
        cellCurso.textContent = aluno.curso || '-';
        
        // Idade
        const cellIdade = row.insertCell();
        cellIdade.textContent = aluno.idade || '-';
        
        // Escola Integrada
        const cellEscola = row.insertCell();
        cellEscola.textContent = aluno.escola_integrada || '-';
        
        // PCD
        const cellPCD = row.insertCell();
        cellPCD.textContent = aluno.pessoa_com_deficiencia ? 'Sim' : 'Não';
        
        // Ocorrências
        const cellOcorrencias = row.insertCell();
        cellOcorrencias.textContent = aluno.ocorrencias || 0;
        
        // Adicionar classe para zebrado
        if (index % 2 === 0) {
          row.classList.add('zebrado');
        }
      });
    }

    // Carregar cursos para o filtro
    async function carregarCursos() {
      try {
        const response = await fetch('http://localhost:5000/dashboard/cursos-list');
        if (!response.ok) {
          throw new Error(`Erro ao buscar cursos: ${response.status}`);
        }
        
        const cursos = await response.json();
        const select = document.getElementById('cursoFiltro');
        
        if (!select) {
          console.error('Elemento cursoFiltro não encontrado');
          return;
        }
        
        // Limpar opções existentes
        select.innerHTML = '<option value="">Todos os Cursos</option>';
        
        // Adicionar cursos
        cursos.forEach(curso => {
          const option = document.createElement('option');
          option.value = curso.id;
          option.textContent = curso.nome || `Curso ${curso.id}`;
          select.appendChild(option);
        });
        
        console.log(`${cursos.length} cursos carregados no filtro`);
      } catch (error) {
        console.error('Erro ao carregar cursos:', error);
        mostrarAviso('Não foi possível carregar a lista de cursos', 'erro');
      }
    }

    // Testar conexão e diagnóstico
    async function testarConexao() {
  try {
    mostrarCarregamento(true);
    
    const response = await fetch('http://localhost:5000/dashboard/diagnostico');
    const data = await response.json();
    
    console.log('Diagnóstico:', data);
    
    if (data.status === 'OK') {
      alert(`✅ SISTEMA OPERANDO\n\n` +
            `• Alunos: ${data.totais?.alunos || 0}\n` +
            `• Turmas: ${data.totais?.turmas || 0}\n` +
            `• Cursos: ${data.totais?.cursos || 0}\n` +
            `• Ocorrências: ${data.totais?.ocorrencias || 0}\n\n` +
            `${data.mensagem || ''}`);
    } else {
      alert(`❌ PROBLEMA DETECTADO\n\n${data.erro || 'Erro desconhecido'}`);
    }
    
  } catch (error) {
    alert(`❌ ERRO DE CONEXÃO\n\nVerifique se o servidor Flask está rodando na porta 5000.`);
    console.error('Erro no teste:', error);
  } finally {
    mostrarCarregamento(false);
  }
}

    // Limpar filtros
    function limparFiltros() {
      document.getElementById('buscaAluno').value = '';
      document.getElementById('buscaTurma').value = '';
      document.getElementById('statusTurma').value = 'todas';
      document.getElementById('cursoFiltro').value = '';
      
      // Recarregar dashboard
      carregarDashboard();
    }

    // Mostrar/ocultar indicador de carregamento
    function mostrarCarregamento(mostrar) {
      const loadingOverlay = document.getElementById('loadingOverlay');
      const btnAplicar = document.getElementById('btnAplicar');
      
      if (loadingOverlay) {
        if (mostrar) {
          loadingOverlay.classList.add('active');
        } else {
          loadingOverlay.classList.remove('active');
        }
      }
      
      if (btnAplicar) {
        if (mostrar) {
          btnAplicar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Carregando...';
          btnAplicar.disabled = true;
        } else {
          btnAplicar.innerHTML = '<i class="fa-solid fa-filter"></i> Aplicar';
          btnAplicar.disabled = false;
        }
      }
    }

    // Mostrar aviso
    function mostrarAviso(mensagem, tipo = 'info') {
      const areaAvisos = document.getElementById('areaAvisos');
      if (!areaAvisos) return;
      
      const aviso = document.createElement('div');
      aviso.className = `aviso ${tipo}`;
      
      let icon = 'fa-info-circle';
      if (tipo === 'erro') icon = 'fa-exclamation-triangle';
      if (tipo === 'sucesso') icon = 'fa-check-circle';
      
      aviso.innerHTML = `
        <i class="fas ${icon}"></i>
        <span>${mensagem}</span>
        <button onclick="this.parentElement.remove()" style="
          margin-left: auto;
          background: none;
          border: none;
          color: inherit;
          cursor: pointer;
          font-size: 16px;
        ">
          <i class="fas fa-times"></i>
        </button>
      `;
      
      areaAvisos.appendChild(aviso);
      
      // Remover automaticamente após 10 segundos
      setTimeout(() => {
        if (aviso.parentElement) {
          aviso.style.opacity = '0';
          aviso.style.transition = 'opacity 0.5s';
          setTimeout(() => {
            if (aviso.parentElement) aviso.remove();
          }, 500);
        }
      }, 10000);
    }

    // Limpar avisos
    function limparAvisos() {
      const areaAvisos = document.getElementById('areaAvisos');
      if (areaAvisos) {
        areaAvisos.innerHTML = '';
      }
    }

    // Inicializar quando a página carregar
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Dashboard inicializando...');
      
      // Carregar cursos no filtro
      carregarCursos();
      
      // Carregar dados do dashboard
      carregarDashboard();
      
      // Configurar botão de aplicar
      const btnAplicar = document.getElementById('btnAplicar');
      if (btnAplicar) {
        btnAplicar.addEventListener('click', carregarDashboard);
      }
      
      // Configurar botão de limpar
      const btnLimpar = document.getElementById('btnLimpar');
      if (btnLimpar) {
        btnLimpar.addEventListener('click', limparFiltros);
      }
      
      // Configurar botão de teste
      const btnTeste = document.getElementById('btnTeste');
      if (btnTeste) {
        btnTeste.addEventListener('click', testarConexao);
      }
      
      // Configurar busca por Enter
      const buscaAluno = document.getElementById('buscaAluno');
      const buscaTurma = document.getElementById('buscaTurma');
      
      if (buscaAluno) {
        buscaAluno.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') carregarDashboard();
        });
      }
      
      if (buscaTurma) {
        buscaTurma.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') carregarDashboard();
        });
      }
      
      console.log('Dashboard inicializado com sucesso');
      
      // Mostrar aviso inicial
      mostrarAviso('Carregando dados do dashboard...', 'info');
    });
  </script>
  
  <script>
    // Garantir que o dashboard seja carregado mesmo se houver erros
    window.addEventListener('error', function(e) {
      console.error('Erro global:', e.error);
    });
  </script>
</body>
</html>