<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cadastro de Ocorrência</title>
  <link rel="stylesheet" href="./css/ocorrencias.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link
    href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;600;700&family=Poppins:wght@300;400;500;600&display=swap"
    rel="stylesheet" />

</head>

<body>
  <header>
    <div class="header-content">
      <div class="logo-container">
        <img src="img/senai-logo.png" class="logo" alt="Logo SENAI" />
        <h1>Sistema de Gestão de Alunos</h1>
      </div>

      <nav>
        <button class="nav-toggle" id="navToggle">
          <i class="fas fa-bars"></i>
        </button>

        <ul id="navMenu">
          <li>
            <a href="./principal.html" class="active"><i class="fas fa-home"></i> Home</a>
          </li>

          <li class="dropdown">
            <a href="#"><i class="fas fa-user-graduate"></i> Alunos <i class="fas fa-chevron-down"></i></a>
            <div class="dropdown-content">
              <a href="./cadastroAluno.html"><i class="fas fa-user-plus"></i> Cadastrar Aluno</a>
              <a href="./consultaAluno.html"><i class="fas fa-search"></i> Consultar Alunos</a>
              <a href="./importar_alunos.html"><i class="fas fa-file-csv"></i> Importar CSV</a>
            </div>
          </li>

          <li>
            <a href="./turmas.html"><i class="fas fa-chalkboard"></i> Turmas</a>
          </li>

          <li>
            <a href="./ocorrencias.html"><i class="fas fa-exclamation-triangle"></i> Ocorrências</a>
          </li>

          <li>
            <a href="./dashboard.html"><i class="fas fa-history"></i> Dashboard</a>
          </li>

          <li>
            <a href="./criar_usuario.html"><i class="fas fa-user-cog"></i> Usuários</a>
          </li>
        </ul>
      </nav>
    </div>
  </header>

  <style>
    body {
      font-family: 'Open Sans', sans-serif;
      background-color: #f5f7fa;
      color: #333;
      margin: 0;
      padding: 20px;
    }
    main { max-width: 1400px; margin: 0 auto; }

    .sem-dados {
      text-align: center;
      padding: 40px;
      color: #666;
      font-style: italic;
      background: #f9f9f9;
      border-radius: 8px;
      margin: 10px;
    }
    .zebrado { background-color: #f9f9f9; }

    .btn-limpar { background-color: #6c757d; color: white; }
    .btn-limpar:hover { background-color: #5a6268; }

    .btn-teste { background-color: #28a745; color: white; }
    .btn-teste:hover { background-color: #218838; }

    .btn-exportar { background-color: #17a2b8; color: white; }
    .btn-exportar:hover { background-color: #138496; }

    .table-container {
      overflow-x: auto;
      margin-top: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    #tabelaAlunos { width: 100%; border-collapse: collapse; min-width: 800px; }
    #tabelaAlunos th {
      background-color: #4a6fa5;
      color: white;
      padding: 12px 15px;
      text-align: left;
      font-weight: 600;
    }
    #tabelaAlunos td {
      padding: 12px 15px;
      border-bottom: 1px solid #ddd;
      vertical-align: middle;
    }
    #tabelaAlunos tr:hover { background-color: #f5f5f5; }

    .btn-ocorrencias {
      background: none;
      border: none;
      color: #4a6fa5;
      font-weight: 700;
      cursor: pointer;
      padding: 0;
      text-decoration: underline;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .btn-ocorrencias:disabled {
      color: #999;
      cursor: not-allowed;
      text-decoration: none;
    }

    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .chart-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      min-height: 300px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .kpis {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .kpi {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      text-align: center;
    }
    .kpi h3 {
      margin: 0 0 10px 0;
      color: #555;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .kpi .value { font-size: 32px; font-weight: 700; color: #4a6fa5; }

    .filters {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    .group { display: flex; flex-direction: column; }
    .group label { margin-bottom: 5px; font-weight: 600; color: #555; }
    .group select, .group input {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }

    .btn {
      padding: 10px 20px;
      background-color: #4a6fa5;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: background-color 0.3s;
      margin-top: 23px;
    }
    .btn:hover { background-color: #3a5a80; }

    .section { margin-bottom: 40px; }
    .section h2 {
      color: #333;
      border-bottom: 2px solid #4a6fa5;
      padding-bottom: 10px;
      margin-bottom: 20px;
    }

    .loading {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(255, 255, 255, 0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
    .loading.active { display: flex; }

    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #4a6fa5;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .aviso {
      background-color: #fff3cd;
      border: 1px solid #ffeaa7;
      color: #856404;
      padding: 12px 15px;
      border-radius: 4px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .aviso.erro { background-color: #f8d7da; border-color: #f5c6cb; color: #721c24; }
    .aviso.sucesso { background-color: #d4edda; border-color: #c3e6cb; color: #155724; }

    /* MODAL */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      z-index: 2000;
      padding: 20px;
      overflow-y: auto;
    }
    .modal.active { display: block; }
    .modal-content {
      background: #fff;
      max-width: 900px;
      margin: 40px auto;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      overflow: hidden;
    }
    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 18px;
      background: #4a6fa5;
      color: #fff;
    }
    .modal-header h3 { margin: 0; font-size: 16px; font-weight: 700; }
    .modal-close {
      background: none;
      border: none;
      color: #fff;
      cursor: pointer;
      font-size: 18px;
    }
    .modal-body { padding: 18px; }
    .modal-body .meta {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 12px;
      color: #555;
      font-size: 13px;
    }
    .ocorrencias-list {
      border: 1px solid #eee;
      border-radius: 8px;
      overflow: hidden;
    }
    .oc-item {
      padding: 12px 14px;
      border-bottom: 1px solid #eee;
    }
    .oc-item:last-child { border-bottom: none; }
    .oc-top {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 6px;
    }
    .badge {
      background: #eef3fb;
      color: #3a5a80;
      border: 1px solid #d9e6f7;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
    }
    .oc-date {
      font-size: 12px;
      color: #666;
    }
    .oc-desc {
      color: #333;
      font-size: 14px;
      line-height: 1.35;
      white-space: pre-wrap;
    }
    .modal-loading {
      display: flex;
      align-items: center;
      gap: 10px;
      color: #555;
      padding: 10px 0;
    }
  </style>
</head>

<body>
  <div id="loadingOverlay" class="loading">
    <div class="spinner"></div>
    <p>Carregando dados do dashboard...</p>
  </div>

  <main>
    <div id="areaAvisos"></div>

    <section class="filters">
      <div class="group">
        <label for="statusTurma">Status da Turma</label>
        <select id="statusTurma">
          <option value="todas">Todas</option>
          <option value="ativas" selected>Ativas</option>
          <option value="finalizadas">Finalizadas</option>
        </select>
      </div>

      <div class="group">
        <label for="cursoFiltro">Curso</label>
        <select id="cursoFiltro">
          <option value="">Todos os Cursos</option>
        </select>
      </div>

      <div class="group">
        <label for="buscaAluno">Buscar Aluno</label>
        <input type="text" id="buscaAluno" placeholder="Nome ou CPF" />
      </div>

      <div class="group">
        <label for="buscaTurma">Buscar Turma</label>
        <input type="text" id="buscaTurma" placeholder="Nome da turma" />
      </div>

      <div class="group">
        <button id="btnAplicar" class="btn">
          <i class="fa-solid fa-filter"></i> Aplicar
        </button>
      </div>

      <div class="group">
        <button id="btnLimpar" class="btn btn-limpar">
          <i class="fa-solid fa-eraser"></i> Limpar
        </button>
      </div>

      <div class="group">
        <button id="btnTeste" class="btn btn-teste">
          <i class="fa-solid fa-bug"></i> Testar
        </button>
      </div>

      <div class="group">
        <button id="btnExportar" class="btn btn-exportar">
          <i class="fa-solid fa-file-export"></i> Exportar CSV
        </button>
      </div>
    </section>

    <section class="section">
      <h2>Indicadores Gerais</h2>
      <div class="kpis">
        <div class="kpi"><h3>Total de Alunos</h3><div class="value" id="kpiTotalAlunos">-</div></div>
        <div class="kpi"><h3>Alunos PCD</h3><div class="value" id="kpiPCD">-</div></div>
        <div class="kpi"><h3>Média de Idade</h3><div class="value" id="kpiMediaIdade">-</div></div>
        <div class="kpi"><h3>Turmas Ativas</h3><div class="value" id="kpiTurmasAtivas">-</div></div>
        <div class="kpi"><h3>Turmas Finalizadas</h3><div class="value" id="kpiTurmasFinalizadas">-</div></div>
        <div class="kpi"><h3>Total Ocorrências</h3><div class="value" id="kpiOcorrencias">-</div></div>
      </div>
    </section>

    <section class="section">
      <h2>Visão Gráfica</h2>
      <div class="charts-grid">
        <div class="chart-card"><canvas id="chartAlunosCurso"></canvas></div>
        <div class="chart-card"><canvas id="chartOcorrenciasCurso"></canvas></div>
        <div class="chart-card"><canvas id="chartEscolas"></canvas></div>
      </div>
    </section>

    <section class="section">
      <h2>Lista de Alunos</h2>
      <div class="table-container">
        <table id="tabelaAlunos">
          <thead>
            <tr>
              <th>ID</th>
              <th>Nome</th>
              <th>Turma</th>
              <th>Curso</th>
              <th>Idade</th>
              <th>Escola Integrada</th>
              <th>PCD</th>
              <th>Ocorrências</th>
            </tr>
          </thead>
          <tbody id="corpoTabelaAlunos">
            <tr>
              <td colspan="8" style="text-align:center; padding:30px; color:#666;">
                Carregando dados do dashboard...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- MODAL OCORRÊNCIAS -->
  <div id="modalOcorrencias" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTituloOcorrencias">Ocorrências do aluno</h3>
        <button class="modal-close" id="btnFecharModal" title="Fechar">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="meta">
          <span><strong>Aluno:</strong> <span id="modalAlunoNome">-</span></span>
          <span><strong>ID:</strong> <span id="modalAlunoId">-</span></span>
          <span><strong>Total:</strong> <span id="modalTotalOcorrencias">-</span></span>
        </div>

        <div id="modalConteudoOcorrencias"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>





  <script>
    const API_BASE = 'http://localhost:5000/dashboard';
    const DEFAULT_LIMIT = 50;

    let dadosDashboardCache = null;
    let chartAlunosCurso = null;
    let chartOcorrenciasCurso = null;
    let chartEscolas = null;

    function qs(id) { return document.getElementById(id); }

    function mostrarCarregamento(mostrar) {
      const overlay = qs('loadingOverlay');
      const btnAplicar = qs('btnAplicar');
      if (overlay) overlay.classList.toggle('active', !!mostrar);
      if (btnAplicar) {
        btnAplicar.disabled = !!mostrar;
        btnAplicar.innerHTML = mostrar
          ? '<i class="fas fa-spinner fa-spin"></i> Carregando...'
          : '<i class="fa-solid fa-filter"></i> Aplicar';
      }
    }

    function limparAvisos() {
      const area = qs('areaAvisos');
      if (area) area.innerHTML = '';
    }

    function mostrarAviso(mensagem, tipo = 'info') {
      const area = qs('areaAvisos');
      if (!area) return;

      const aviso = document.createElement('div');
      aviso.className = `aviso ${tipo}`;

      let icon = 'fa-info-circle';
      if (tipo === 'erro') icon = 'fa-exclamation-triangle';
      if (tipo === 'sucesso') icon = 'fa-check-circle';

      aviso.innerHTML = `
        <i class="fas ${icon}"></i>
        <span>${mensagem}</span>
        <button onclick="this.parentElement.remove()" style="
          margin-left:auto;background:none;border:none;color:inherit;
          cursor:pointer;font-size:16px;">
          <i class="fas fa-times"></i>
        </button>
      `;

      area.appendChild(aviso);

      setTimeout(() => {
        if (aviso.parentElement) {
          aviso.style.opacity = '0';
          aviso.style.transition = 'opacity 0.5s';
          setTimeout(() => { if (aviso.parentElement) aviso.remove(); }, 500);
        }
      }, 10000);
    }

    function formatarNumero(valor) {
      if (valor === undefined || valor === null) return '-';
      if (valor === 0) return '0';
      return Number.isInteger(valor) ? valor.toString() : Number(valor).toFixed(1);
    }

    function getFiltros() {
      return {
        statusTurma: qs('statusTurma')?.value || 'todas',
        cursoId: qs('cursoFiltro')?.value || '',
        buscaAluno: (qs('buscaAluno')?.value || '').trim(),
        buscaTurma: (qs('buscaTurma')?.value || '').trim(),
        limit: DEFAULT_LIMIT,
        offset: 0
      };
    }

    function buildQueryString(filtros) {
      const params = new URLSearchParams();
      if (filtros.statusTurma) params.set('statusTurma', filtros.statusTurma);
      if (filtros.cursoId) params.set('cursoId', filtros.cursoId);
      if (filtros.buscaAluno) params.set('buscaAluno', filtros.buscaAluno);
      if (filtros.buscaTurma) params.set('buscaTurma', filtros.buscaTurma);
      if (filtros.limit) params.set('limit', String(filtros.limit));
      if (filtros.offset) params.set('offset', String(filtros.offset));
      return params.toString();
    }

    // ===== MODAL =====
    function abrirModalOcorrencias(alunoId, alunoNome) {
      const modal = qs('modalOcorrencias');
      if (!modal) return;

      qs('modalAlunoId').textContent = alunoId ?? '-';
      qs('modalAlunoNome').textContent = alunoNome ?? '-';
      qs('modalTotalOcorrencias').textContent = '-';

      qs('modalConteudoOcorrencias').innerHTML = `
        <div class="modal-loading">
          <i class="fas fa-spinner fa-spin"></i>
          <span>Carregando ocorrências...</span>
        </div>
      `;

      modal.classList.add('active');
      modal.setAttribute('aria-hidden', 'false');

      carregarOcorrenciasAluno(alunoId);
    }

    function fecharModalOcorrencias() {
      const modal = qs('modalOcorrencias');
      if (!modal) return;
      modal.classList.remove('active');
      modal.setAttribute('aria-hidden', 'true');
    }

    function setupModal() {
      const modal = qs('modalOcorrencias');
      const btnFechar = qs('btnFecharModal');

      btnFechar?.addEventListener('click', fecharModalOcorrencias);

      modal?.addEventListener('click', (e) => {
        if (e.target === modal) fecharModalOcorrencias();
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal?.classList.contains('active')) fecharModalOcorrencias();
      });
    }

    async function carregarOcorrenciasAluno(alunoId) {
      try {
        const resp = await fetch(`${API_BASE}/aluno/${alunoId}/ocorrencias`);
        if (!resp.ok) throw new Error(`Falha ao buscar ocorrências (HTTP ${resp.status})`);

        const data = await resp.json();
        const total = data.total ?? 0;
        qs('modalTotalOcorrencias').textContent = total;

        const container = qs('modalConteudoOcorrencias');

        if (!Array.isArray(data.ocorrencias) || data.ocorrencias.length === 0) {
          container.innerHTML = `<div class="sem-dados" style="margin:0;">Nenhuma ocorrência registrada para este aluno.</div>`;
          return;
        }

        const html = data.ocorrencias.map(o => {
          const tipo = o.tipo ?? 'Não informado';

          // prioridade: data_ocorrencia (date do evento) e depois data (created_at)
          const dataOc = o.data_ocorrencia ? formatarDataISO(o.data_ocorrencia) : null;
          const dataReg = o.data ? formatarDataHoraISO(o.data) : null;

          const descricao = (o.descricao ?? '').toString().trim() || '(Sem descrição)';
          const turmaNome = o.turma_nome ? `Turma: ${o.turma_nome}` : null;

          return `
            <div class="oc-item">
              <div class="oc-top">
                <span class="badge">${tipo}</span>
                ${dataOc ? `<span class="oc-date"><i class="fa-regular fa-calendar"></i> Ocorrência: ${dataOc}</span>` : ''}
                ${dataReg ? `<span class="oc-date"><i class="fa-regular fa-clock"></i> Registro: ${dataReg}</span>` : ''}
                ${turmaNome ? `<span class="oc-date"><i class="fa-solid fa-chalkboard-user"></i> ${turmaNome}</span>` : ''}
                ${o.id ? `<span class="oc-date"><i class="fa-solid fa-hashtag"></i> ${o.id}</span>` : ''}
              </div>
              <div class="oc-desc">${escapeHtml(descricao)}</div>
            </div>
          `;
        }).join('');

        container.innerHTML = `<div class="ocorrencias-list">${html}</div>`;
      } catch (e) {
        console.error(e);
        qs('modalConteudoOcorrencias').innerHTML = `
          <div class="aviso erro" style="margin:0;">
            <i class="fas fa-exclamation-triangle"></i>
            <span>Erro ao carregar ocorrências: ${e.message}</span>
          </div>
        `;
      }
    }

    function formatarDataISO(iso) {
      // iso YYYY-MM-DD
      try {
        const [y, m, d] = iso.slice(0,10).split('-');
        return `${d}/${m}/${y}`;
      } catch {
        return iso;
      }
    }

    function formatarDataHoraISO(iso) {
      // iso datetime
      try {
        const dt = new Date(iso);
        const dd = String(dt.getDate()).padStart(2, '0');
        const mm = String(dt.getMonth() + 1).padStart(2, '0');
        const yy = dt.getFullYear();
        const hh = String(dt.getHours()).padStart(2, '0');
        const mi = String(dt.getMinutes()).padStart(2, '0');
        return `${dd}/${mm}/${yy} ${hh}:${mi}`;
      } catch {
        return iso;
      }
    }

    function escapeHtml(str) {
      return str
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    // ===== API =====
    async function carregarCursos() {
      try {
        const resp = await fetch(`${API_BASE}/cursos-list`);
        if (!resp.ok) throw new Error(`Erro ao buscar cursos: ${resp.status}`);
        const cursos = await resp.json();

        const select = qs('cursoFiltro');
        if (!select) return;

        select.innerHTML = '<option value="">Todos os Cursos</option>';
        cursos.forEach(curso => {
          const opt = document.createElement('option');
          opt.value = curso.id;
          opt.textContent = curso.nome || `Curso ${curso.id}`;
          select.appendChild(opt);
        });
      } catch (e) {
        console.error(e);
        mostrarAviso('Não foi possível carregar a lista de cursos', 'erro');
      }
    }

    async function carregarDashboard() {
      try {
        mostrarCarregamento(true);
        limparAvisos();

        const filtros = getFiltros();
        const qsParams = buildQueryString(filtros);
        const url = qsParams ? `${API_BASE}?${qsParams}` : API_BASE;

        const resp = await fetch(url);
        if (!resp.ok) throw new Error(`Erro ${resp.status}: ${resp.statusText}`);

        const dados = await resp.json();
        dadosDashboardCache = dados;

        atualizarKPIs(dados);
        if (dados.graficos) renderizarGraficos(dados.graficos);

        if (Array.isArray(dados.alunosFiltrados)) {
          renderizarTabelaAlunos(dados.alunosFiltrados);

          if (dados.alunosFiltrados.length === 0) {
            mostrarAviso('Nenhum aluno encontrado com os filtros atuais.', 'info');
          } else {
            mostrarAviso(`Carregados ${dados.alunosFiltrados.length} alunos (limit ${DEFAULT_LIMIT}).`, 'sucesso');
          }
        }

        if (dados.mensagem) mostrarAviso(dados.mensagem, 'info');
      } catch (error) {
        console.error('Erro ao carregar dashboard:', error);
        mostrarAviso(`Erro: ${error.message}`, 'erro');
        renderizarErroTabela(error.message);
      } finally {
        mostrarCarregamento(false);
      }
    }

    async function testarConexao() {
      try {
        mostrarCarregamento(true);
        const resp = await fetch(`${API_BASE}/diagnostico`);
        const data = await resp.json();

        if (data.status === 'OK') {
          alert(`✅ SISTEMA OPERANDO\n\n` +
            `• Alunos: ${data.totais?.alunos || 0}\n` +
            `• Turmas: ${data.totais?.turmas || 0}\n` +
            `• Cursos: ${data.totais?.cursos || 0}\n` +
            `• Ocorrências: ${data.totais?.ocorrencias || 0}\n\n` +
            `${data.mensagem || ''}`);
        } else {
          alert(`❌ PROBLEMA DETECTADO\n\n${data.erro || 'Erro desconhecido'}`);
        }
      } catch (e) {
        alert(`❌ ERRO DE CONEXÃO\n\nVerifique se o servidor Flask está rodando na porta 5000.`);
        console.error(e);
      } finally {
        mostrarCarregamento(false);
      }
    }

    function limparFiltros() {
      qs('buscaAluno').value = '';
      qs('buscaTurma').value = '';
      qs('statusTurma').value = 'todas';
      qs('cursoFiltro').value = '';
      carregarDashboard();
    }

    async function exportarCSV() {
      try {
        const filtros = getFiltros();
        const params = new URLSearchParams();

        if (filtros.statusTurma) params.set('statusTurma', filtros.statusTurma);
        if (filtros.cursoId) params.set('cursoId', filtros.cursoId);
        if (filtros.buscaAluno) params.set('buscaAluno', filtros.buscaAluno);
        if (filtros.buscaTurma) params.set('buscaTurma', filtros.buscaTurma);

        const url = `${API_BASE}/export?${params.toString()}`;
        const resp = await fetch(url);
        if (!resp.ok) throw new Error('Falha ao exportar CSV.');

        const blob = await resp.blob();
        const hoje = new Date().toISOString().slice(0, 10);
        const nome = `relatorio_dashboard_${hoje}.csv`;

        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = nome;
        document.body.appendChild(a);
        a.click();
        a.remove();

        mostrarAviso('Relatório CSV exportado com sucesso.', 'sucesso');
      } catch (e) {
        console.error(e);
        mostrarAviso(e.message || 'Erro ao exportar CSV.', 'erro');
      }
    }

    // ===== RENDER =====
    function atualizarKPIs(dados) {
      qs('kpiTotalAlunos').textContent = formatarNumero(dados.totalAlunos);
      qs('kpiPCD').textContent = formatarNumero(dados.alunosPCD);
      qs('kpiMediaIdade').textContent = formatarNumero(dados.mediaIdade);
      qs('kpiTurmasAtivas').textContent = formatarNumero(dados.turmasAtivas);
      qs('kpiTurmasFinalizadas').textContent = formatarNumero(dados.turmasFinalizadas);
      qs('kpiOcorrencias').textContent = formatarNumero(dados.totalOcorrencias);
    }

    function renderizarErroTabela(msg) {
      const tbody = qs('corpoTabelaAlunos');
      if (!tbody) return;

      tbody.innerHTML = '';
      const row = tbody.insertRow();
      const cell = row.insertCell();
      cell.colSpan = 8;

      cell.innerHTML = `
        <div style="text-align:center;padding:30px;color:#666;">
          <i class="fas fa-exclamation-triangle" style="font-size:36px;margin-bottom:15px;color:#dc3545;"></i>
          <h4 style="margin:0 0 10px 0;">Não foi possível carregar os dados</h4>
          <p style="margin:0 0 15px 0;">${msg}</p>
          <button onclick="location.reload()" class="btn" style="background-color:#dc3545;">
            <i class="fas fa-redo"></i> Recarregar página
          </button>
        </div>
      `;
    }

    function renderizarTabelaAlunos(alunos) {
      const tbody = qs('corpoTabelaAlunos');
      if (!tbody) return;

      tbody.innerHTML = '';

      if (!alunos || alunos.length === 0) {
        const row = tbody.insertRow();
        const cell = row.insertCell();
        cell.colSpan = 8;
        cell.innerHTML = `
          <div style="text-align:center;padding:40px;color:#666;">
            <i class="fas fa-user-slash" style="font-size:48px;margin-bottom:20px;opacity:0.3;"></i>
            <h3 style="margin:0 0 10px 0;">Nenhum aluno encontrado</h3>
            <p style="margin:0;">Tente ajustar os filtros de busca</p>
          </div>
        `;
        return;
      }

      alunos.forEach((aluno, index) => {
        const row = tbody.insertRow();

        row.insertCell().textContent = aluno.id ?? '-';
        row.insertCell().textContent = aluno.nome ?? '-';
        row.insertCell().textContent = aluno.turma ?? '-';
        row.insertCell().textContent = aluno.curso ?? '-';
        row.insertCell().textContent = aluno.idade ?? '-';
        row.insertCell().textContent = aluno.escola_integrada ?? '-';
        row.insertCell().textContent = aluno.pessoa_com_deficiencia ? 'Sim' : 'Não';

        const tdOc = row.insertCell();
        const qtd = Number(aluno.ocorrencias ?? 0);

        const btn = document.createElement('button');
        btn.className = 'btn-ocorrencias';
        btn.type = 'button';
        btn.innerHTML = `<i class="fa-regular fa-eye"></i> ${qtd}`;

        if (qtd <= 0) {
          btn.disabled = true;
          btn.title = 'Sem ocorrências';
        } else {
          btn.title = 'Ver ocorrências';
          btn.addEventListener('click', () => abrirModalOcorrencias(aluno.id, aluno.nome));
        }

        tdOc.appendChild(btn);

        if (index % 2 === 0) row.classList.add('zebrado');
      });
    }

    function ensureSemDados(canvasEl, msg) {
      const parent = canvasEl.parentElement;
      const old = parent.querySelector('.sem-dados');
      if (old) old.remove();
      canvasEl.style.display = 'none';
      parent.insertAdjacentHTML('beforeend', `<p class="sem-dados">${msg}</p>`);
    }

    function clearSemDados(canvasEl) {
      const parent = canvasEl.parentElement;
      const old = parent.querySelector('.sem-dados');
      if (old) old.remove();
      canvasEl.style.display = 'block';
    }

    function renderizarGraficos(graficos) {
      if (chartAlunosCurso) chartAlunosCurso.destroy();
      if (chartOcorrenciasCurso) chartOcorrenciasCurso.destroy();
      if (chartEscolas) chartEscolas.destroy();

      const c1 = qs('chartAlunosCurso');
      if (c1) {
        const labels = Object.keys(graficos.alunosPorCurso || {});
        const values = Object.values(graficos.alunosPorCurso || {});
        if (labels.length === 0) {
          ensureSemDados(c1, 'Nenhum dado disponível para alunos por curso');
        } else {
          clearSemDados(c1);
          chartAlunosCurso = new Chart(c1.getContext('2d'), {
            type: 'bar',
            data: {
              labels,
              datasets: [{
                label: 'Alunos por Curso',
                data: values,
                backgroundColor: 'rgba(74, 111, 165, 0.6)',
                borderColor: 'rgba(74, 111, 165, 1)',
                borderWidth: 2,
                borderRadius: 5
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: { display: true, position: 'top' },
                title: { display: true, text: 'Distribuição de Alunos por Curso' }
              },
              scales: {
                y: { beginAtZero: true, title: { display: true, text: 'Número de Alunos' } },
                x: { title: { display: true, text: 'Cursos' } }
              }
            }
          });
        }
      }

      const c2 = qs('chartOcorrenciasCurso');
      if (c2) {
        const labels = Object.keys(graficos.ocorrenciasPorTipo || {});
        const values = Object.values(graficos.ocorrenciasPorTipo || {});
        if (labels.length === 0) {
          ensureSemDados(c2, 'Nenhuma ocorrência registrada');
        } else {
          clearSemDados(c2);
          chartOcorrenciasCurso = new Chart(c2.getContext('2d'), {
            type: 'pie',
            data: { labels, datasets: [{ label: 'Ocorrências por Tipo', data: values }] },
            options: {
              responsive: true,
              plugins: {
                legend: { position: 'right' },
                title: { display: true, text: 'Distribuição de Ocorrências por Tipo' }
              }
            }
          });
        }
      }

      const c3 = qs('chartEscolas');
      if (c3) {
        const labels = Object.keys(graficos.escolas || {});
        const values = Object.values(graficos.escolas || {});
        if (labels.length === 0) {
          ensureSemDados(c3, 'Nenhum dado disponível para escolas');
        } else {
          clearSemDados(c3);
          chartEscolas = new Chart(c3.getContext('2d'), {
            type: 'doughnut',
            data: { labels, datasets: [{ label: 'Escolas Integradas', data: values }] },
            options: {
              responsive: true,
              plugins: {
                legend: { position: 'right' },
                title: { display: true, text: 'Distribuição por Escola Integrada' }
              }
            }
          });
        }
      }
    }

    // ===== INIT =====
    document.addEventListener('DOMContentLoaded', () => {
      setupModal();
      carregarCursos();
      carregarDashboard();
      mostrarAviso('Carregando dados do dashboard...', 'info');

      qs('btnAplicar')?.addEventListener('click', carregarDashboard);
      qs('btnLimpar')?.addEventListener('click', limparFiltros);
      qs('btnTeste')?.addEventListener('click', testarConexao);
      qs('btnExportar')?.addEventListener('click', exportarCSV);

      qs('buscaAluno')?.addEventListener('keypress', (e) => { if (e.key === 'Enter') carregarDashboard(); });
      qs('buscaTurma')?.addEventListener('keypress', (e) => { if (e.key === 'Enter') carregarDashboard(); });
    });

    window.addEventListener('error', function(e) {
      console.error('Erro global:', e.error || e.message);
    });
  </script>
</body>
</html>
