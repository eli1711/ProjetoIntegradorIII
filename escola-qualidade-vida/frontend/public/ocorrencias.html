<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cadastro de OcorrÃªncia</title>
  <link rel="stylesheet" href="./css/ocorrencias.css" />
  <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;600;700&family=Poppins:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <script src="js/navbar-protection.js"></script>
</head>

<body>
  <header>
      <div class="header-content">
        <div class="logo-container">
          <img
            src="img/senai-logo.png"
            class="logo"
            alt="Logo SENAI"
          />
          <h1>Sistema de GestÃ£o de Alunos</h1>
        </div>

        <nav>
          <button class="nav-toggle" id="navToggle">
            <i class="fas fa-bars"></i>
          </button>

          <ul id="navMenu">
            <li>
              <a href="./principal.html" class="active"
                ><i class="fas fa-home"></i> Home</a
              >
            </li>

            <li class="dropdown">
              <a href="#"
                ><i class="fas fa-user-graduate"></i> Alunos
                <i class="fas fa-chevron-down"></i
              ></a>
              <div class="dropdown-content">
                <a href="./cadastroAluno.html"
                  ><i class="fas fa-user-plus"></i> Cadastrar Aluno</a
                >
                <a href="./consultaAluno.html"
                  ><i class="fas fa-search"></i> Consultar Alunos</a
                >
                <a href="./importar_alunos.html"
                  ><i class="fas fa-file-csv"></i> Importar CSV</a
                >
              </div>
            </li>

            <li>
              <a href="./turmas.html"
                ><i class="fas fa-chalkboard"></i> Turmas</a
              >
            </li>

            <li>
              <a href="./ocorrencias.html"
                ><i class="fas fa-exclamation-triangle"></i> OcorrÃªncias</a
              >
            </li>

            <li>
              <a href="./dashboard.html">
                <i class="fas fa-history"></i> Dashboard</a>
            </li>

            <li>
              <a href="./criar_usuario.html"
                ><i class="fas fa-user-cog"></i> UsuÃ¡rios</a
              >
            </li>
          </ul>
        </nav>
      </div>
    </header>

  <main>
    <div class="container">
      <div class="form-container">
        <div class="form-header">
          <h2><i class="fas fa-user-plus"></i> Cadastrar OcorrÃªncias</h2>
        </div>
    <div id="alerta" style="display: none;"></div>

    <label for="buscar_nome">Buscar aluno por nome:</label>
    <input type="text" id="buscar_nome" placeholder="Digite o nome..." autocomplete="off" />
    <ul id="sugestoes" style="list-style: none; padding-left: 0;"></ul>

    <div id="aluno_selecionado" style="margin: 15px 0; display: none; align-items:center; gap:12px;">
      <img id="foto_exibida" src="" alt="Foto do Aluno" style="width:80px;height:80px;object-fit:cover;border-radius:8px;border:1px solid #ddd;" />
      <div>
        <strong id="nome_exibido"></strong><br />
      </div>
    </div>

    <form id="ocorrenciaForm">
      <input type="hidden" id="aluno_id" name="aluno_id" required />

      <label for="tipo">Tipo de OcorrÃªncia:</label>
      <select id="tipo" name="tipo" required>
        <option value="" selected disabled>Selecione uma opÃ§Ã£o...</option>
        <option value="atraso">Atraso</option>
        <option value="atestado">Atestado MÃ©dico</option>
        <option value="saude">Problema de saÃºde</option>
      </select>

      <label for="descricao">DescriÃ§Ã£o:</label>
      <textarea id="descricao" name="descricao" required></textarea>

      <label for="data_ocorrencia">Data da OcorrÃªncia:</label>
      <input type="date" id="data_ocorrencia" name="data_ocorrencia" />

      <button type="submit">Cadastrar</button>
    </form>
  </main>

  <script>
    const buscarInput = document.getElementById("buscar_nome");
    const sugestoesUl = document.getElementById("sugestoes");
    const alunoSelecionadoDiv = document.getElementById("aluno_selecionado");
    const nomeExibido = document.getElementById("nome_exibido");
    const fotoExibida = document.getElementById("foto_exibida");
    const alunoIdInput = document.getElementById("aluno_id");
    const form = document.getElementById("ocorrenciaForm");

    // ðŸ” Busca alunos conforme o usuÃ¡rio digita
    buscarInput.addEventListener("input", async () => {
      const nome = buscarInput.value.trim();
      sugestoesUl.innerHTML = "";
      if (nome.length < 2) return;

      try {
        const response = await fetch(`http://localhost:5000/alunos/buscar?nome=${encodeURIComponent(nome)}`);
        const data = await response.json();

        if (response.ok && Array.isArray(data)) {
          data.forEach(aluno => {
            const li = document.createElement("li");
            li.textContent = `${aluno.nome} (${aluno.matricula})`;
            li.style.cursor = "pointer";
            li.onclick = () => selecionarAluno(aluno);
            sugestoesUl.appendChild(li);
          });
        }
      } catch (err) {
        console.error("Erro ao buscar alunos:", err);
      }
    });

    // ðŸŽ¯ Seleciona aluno e exibe foto
    function selecionarAluno(aluno) {
      alunoSelecionadoDiv.style.display = "flex";
      nomeExibido.textContent = aluno.nome;
      alunoIdInput.value = aluno.id;

      // Monta URL da foto (ou mostra imagem padrÃ£o)
      if (aluno.foto_url) {
        fotoExibida.src = aluno.foto_url;
      } else {
        fotoExibida.src = "./img/sem-foto.png"; // imagem fallback
      }

      sugestoesUl.innerHTML = "";
      buscarInput.value = aluno.nome;
    }

    // ðŸ“¤ Envio do formulÃ¡rio de ocorrÃªncia
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      // validaÃ§Ã£o bÃ¡sica: precisa ter aluno escolhido
      if (!alunoIdInput.value) {
        alert("Selecione um aluno antes de cadastrar a ocorrÃªncia.");
        return;
      }

      const payload = {
        aluno_id: Number(alunoIdInput.value),
        tipo: document.getElementById("tipo").value,
        descricao: document.getElementById("descricao").value.trim(),
        data_ocorrencia: document.getElementById("data_ocorrencia").value || null
      };

      try {
        // use a barra final para nÃ£o tomar 308
        const response = await fetch("http://localhost:5000/ocorrencias/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const data = await response.json();

        if (response.ok) {
          alert(data.mensagem || "OcorrÃªncia cadastrada com sucesso!");
          form.reset();
          alunoSelecionadoDiv.style.display = "none";
        } else {
          alert(data.erro || "Erro ao cadastrar ocorrÃªncia.");
          console.error("Detalhes:", data.detalhes || data);
        }
      } catch (error) {
        console.error("Erro ao cadastrar ocorrÃªncia:", error);
        alert("Falha ao cadastrar ocorrÃªncia.");
      }
    });
  </script>
</body>
</html>
