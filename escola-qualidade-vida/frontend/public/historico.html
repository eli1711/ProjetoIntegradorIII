<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Histórico e Indicadores</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&family=Poppins:wght@500;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --primary:#c40000;--primary-dark:#8a0000;--secondary:#000283;--bg:#f5f7fa;--card:#fff;--muted:#6c757d;--line:#e9ecef;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Open Sans',sans-serif;background:var(--bg);color:#212529;line-height:1.5}
    header{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;padding:1rem 1.25rem;box-shadow:0 2px 10px rgba(0,0,0,.08)}
    header h1{font-family:'Poppins',sans-serif;font-weight:600}
    header nav ul{list-style:none;display:flex;gap:1rem;margin-top:.6rem;flex-wrap:wrap}
    header nav a{color:#fff;text-decoration:none;padding:.35rem .6rem;border-radius:6px}
    header nav a:hover{background:rgba(255,255,255,.15)}
    main{max-width:1200px;margin:1.25rem auto;padding:0 1rem}

    .filters,.kpis,.cards{display:grid;gap:1rem}
    .filters{grid-template-columns:repeat(auto-fit,minmax(220px,1fr));background:var(--card);padding:1rem;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.06);align-items:end}
    .filters .group label{display:block;font-weight:600;margin-bottom:.35rem}
    .filters select,.filters input{width:100%;padding:.6rem .75rem;border:1px solid var(--line);border-radius:8px}
    .filters .btn{background:var(--secondary);color:#fff;border:none;border-radius:8px;padding:.65rem .9rem;cursor:pointer;font-weight:700}
    .filters .btn-outline{background:#fff;color:var(--secondary);border:1px solid var(--secondary)}
    .filters .btn-danger{background:#c92a2a}

    .section{margin-top:1rem}
    .section h2{font-family:'Poppins',sans-serif;font-weight:600;margin:.25rem 0 .75rem;color:var(--secondary)}
    .kpis{grid-template-columns:repeat(auto-fit,minmax(180px,1fr))}
    .kpi{background:var(--card);border-radius:12px;padding:1rem;box-shadow:0 4px 12px rgba(0,0,0,.06)}
    .kpi h3{font-size:.9rem;color:var(--muted);margin-bottom:.4rem}
    .kpi .value{font-size:1.6rem;font-weight:700}

    .table-card{background:var(--card);border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.06);overflow:hidden}
    .table-head{display:flex;justify-content:space-between;align-items:center;padding:1rem;border-bottom:1px solid var(--line)}
    .table-head h3{font-family:'Poppins',sans-serif}
    .table-tools{display:flex;gap:.5rem}
    .btn-sm{padding:.45rem .8rem;border-radius:8px;border:1px solid var(--line);background:#fff;cursor:pointer}
    .btn-sm.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    .btn-sm.secondary{background:var(--secondary);border-color:var(--secondary);color:#fff}
    .table-wrap{overflow:auto}
    table{width:100%;border-collapse:collapse;font-size:.95rem}
    th,td{padding:.75rem .9rem;border-bottom:1px solid var(--line);white-space:nowrap}
    th{background:#fbfbfd;text-align:left}
    .pill{display:inline-block;padding:.15rem .55rem;border-radius:999px;font-size:.8rem;border:1px solid #ddd}
    .pill.green{background:#e9f9ee;color:#27854d;border-color:#bce3c8}
    .pill.gray{background:#eef2f7;color:#5c6773;border-color:#d9e1ea}
    .muted{color:var(--muted)}
    .hidden{display:none}

    .legend{display:flex;gap:.75rem;align-items:center;color:var(--muted);font-size:.9rem}
    .legend span{display:inline-flex;align-items:center;gap:.35rem}
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.green{background:#2ea043}
    .dot.gray{background:#6c757d}

    @media (max-width:700px){
      th,td{white-space:normal}
    }
  </style>
</head>
<body>
  <header>
    <h1>Histórico / Indicadores</h1>
    <nav>
      <ul>
        <li><a href="./principal.html">Home</a></li>
        <li><a href="./cadastroAluno.html">Cadastro de Aluno</a></li>
        <li><a href="./ocorrencias.html">Ocorrências</a></li>
        <li><a href="./relatorios.html">Relatórios</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <!-- FILTROS -->
    <section class="filters">
      <div class="group">
        <label for="statusTurma">Status da Turma</label>
        <select id="statusTurma">
          <option value="todas">Todas</option>
          <option value="ativas" selected>Ativas</option>
          <option value="finalizadas">Finalizadas</option>
        </select>
      </div>
      <div class="group">
        <label for="cursoFiltro">Curso</label>
        <select id="cursoFiltro">
          <option value="">Todos</option>
        </select>
      </div>
      <div class="group">
        <label for="buscaAluno">Buscar Aluno</label>
        <input type="text" id="buscaAluno" placeholder="Nome do aluno"/>
      </div>
      <div class="group">
        <label for="buscaTurma">Buscar Turma</label>
        <input type="text" id="buscaTurma" placeholder="Nome da turma"/>
      </div>
      <div class="group">
        <button id="btnAplicar" class="btn"><i class="fa-solid fa-filter"></i> Aplicar</button>
      </div>
      <div class="group">
        <button id="btnLimpar" class="btn btn-outline"><i class="fa-solid fa-eraser"></i> Limpar</button>
      </div>
    </section>

    <!-- KPIs -->
    <section class="section">
      <h2>Indicadores</h2>
      <div class="kpis">
        <div class="kpi"><h3>Alunos (total)</h3><div class="value" id="kpiTotalAlunos">-</div></div>
        <div class="kpi"><h3>PCD (alunos)</h3><div class="value" id="kpiPCD">-</div></div>
        <div class="kpi"><h3>Média de Idade</h3><div class="value" id="kpiMediaIdade">-</div></div>
        <div class="kpi"><h3>Turmas Ativas</h3><div class="value" id="kpiTurmasAtivas">-</div></div>
        <div class="kpi"><h3>Turmas Finalizadas</h3><div class="value" id="kpiTurmasFinalizadas">-</div></div>
        <div class="kpi"><h3>Ocorrências (total)</h3><div class="value" id="kpiOcorrencias">-</div></div>
      </div>
      <div class="legend" style="margin-top:.5rem">
        <span><span class="dot green"></span>Ativas</span>
        <span><span class="dot gray"></span>Finalizadas</span>
      </div>
    </section>

    <!-- POR TURMA -->
    <section class="section table-card">
      <div class="table-head">
        <h3>Resumo por Turma</h3>
        <div class="table-tools">
          <button class="btn-sm" id="exportTurmas"><i class="fa-solid fa-file-export"></i> CSV</button>
        </div>
      </div>
      <div class="table-wrap">
        <table id="tblTurmas">
          <thead>
            <tr>
              <th>ID</th>
              <th>Turma</th>
              <th>Curso</th>
              <th>Sem.</th>
              <th>Início</th>
              <th>Término</th>
              <th>Status</th>
              <th>Alunos</th>
              <th>Ocorrências</th>
            </tr>
          </thead>
          <tbody><tr><td colspan="9" class="muted">Carregando...</td></tr></tbody>
        </table>
      </div>
    </section>

    <!-- POR ALUNO -->
    <section class="section table-card">
      <div class="table-head">
        <h3>Resumo por Aluno</h3>
        <div class="table-tools">
          <button class="btn-sm" id="exportAlunos"><i class="fa-solid fa-file-export"></i> CSV</button>
        </div>
      </div>
      <div class="table-wrap">
        <table id="tblAlunos">
          <thead>
            <tr>
              <th>ID</th>
              <th>Aluno</th>
              <th>Turma</th>
              <th>Curso</th>
              <th>Idade</th>
              <th>Escola Integrada</th>
              <th>PCD</th>
              <th>Ocorrências</th>
            </tr>
          </thead>
          <tbody><tr><td colspan="8" class="muted">Carregando...</td></tr></tbody>
        </table>
      </div>
    </section>

    <!-- DISTRIBUIÇÃO POR ESCOLA INTEGRADA -->
    <section class="section table-card">
      <div class="table-head">
        <h3>Distribuição por Escola Integrada</h3>
      </div>
      <div class="table-wrap">
        <table id="tblEscola">
          <thead>
            <tr>
              <th>Escola Integrada</th>
              <th>Alunos</th>
              <th>%</th>
            </tr>
          </thead>
          <tbody><tr><td colspan="3" class="muted">Carregando...</td></tr></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    // ------- Utils -------
    const API = {
      turmas: (status='todas', cursoId='') => {
        const p = new URLSearchParams();
        if (status) p.set('status', status);
        if (cursoId) p.set('curso_id', cursoId);
        return fetch(`http://localhost:5000/turmas/?${p.toString()}`).then(r=>r.json());
      },
      alunos: () => fetch('http://localhost:5000/alunos/buscar').then(r=>r.json()),
      ocorrencias: () => fetch('http://localhost:5000/ocorrencias/').then(r=>r.json())
    };

    const el = sel => document.querySelector(sel);
    const els = sel => Array.from(document.querySelectorAll(sel));

    function toCSV(rows){
      return rows.map(r=>r.map(v=>{
        const s = (v ?? '').toString().replaceAll('"','""');
        return /[",\n;]/.test(s) ? `"${s}"` : s;
      }).join(';')).join('\n');
    }
    function download(name, content){
      const blob = new Blob([content],{type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = name; a.click();
      URL.revokeObjectURL(url);
    }

    // ------- Estado -------
    let DATA = {
      turmas: [],
      alunos: [],
      ocorrencias: []
    };

    // ------- Filtros -------
    const statusTurma = el('#statusTurma');
    const cursoFiltro = el('#cursoFiltro');
    const buscaAluno  = el('#buscaAluno');
    const buscaTurma  = el('#buscaTurma');

    el('#btnLimpar').addEventListener('click', ()=>{
      statusTurma.value = 'todas';
      cursoFiltro.value = '';
      buscaAluno.value = '';
      buscaTurma.value = '';
      render();
    });

    el('#btnAplicar').addEventListener('click', render);

    // ------- Carrega Cursos para o select (a partir das turmas) -------
    async function hydrateCursosNoFiltro(){
      // pegar todas as turmas para extrair cursos únicos
      const all = await API.turmas('todas','');
      const nomes = new Set();
      (all||[]).forEach(t=>{ if (t?.curso_nome) nomes.add(t.curso_nome); });
      // monta opções
      cursoFiltro.innerHTML = `<option value="">Todos</option>`;
      [...nomes].sort().forEach(n=>{
        // o filtro usará o nome do curso; no fetch usaremos curso_id quando disponível
        const opt = document.createElement('option');
        opt.value = n;
        opt.textContent = n;
        cursoFiltro.appendChild(opt);
      });
    }

    // ------- Carrega tudo e monta -------
    async function loadAll(){
      const [turmas, alunos, ocorrencias] = await Promise.all([
        API.turmas('todas',''),
        API.alunos(),
        API.ocorrencias()
      ]);
      DATA.turmas = Array.isArray(turmas)?turmas:[];
      DATA.alunos = Array.isArray(alunos)?alunos:[];
      DATA.ocorrencias = Array.isArray(ocorrencias)?ocorrencias:[];
      await hydrateCursosNoFiltro();
      render();
    }

    // ------- Render principal -------
    function render(){
      // aplica filtro de status / curso / busca textual
      const status = statusTurma.value;     // todas | ativas | finalizadas
      const cursoNome = cursoFiltro.value.trim().toLowerCase();
      const fAluno = buscaAluno.value.trim().toLowerCase();
      const fTurma = buscaTurma.value.trim().toLowerCase();

      let turmas = DATA.turmas.slice();
      if (status === 'ativas') turmas = turmas.filter(t=>t.ativa === true);
      else if (status === 'finalizadas') turmas = turmas.filter(t=>t.ativa === false);

      if (cursoNome) turmas = turmas.filter(t=>(t.curso_nome||'').toLowerCase().includes(cursoNome));
      if (fTurma) turmas = turmas.filter(t=>(t.nome||'').toLowerCase().includes(fTurma));

      // map auxiliares
      const alunos = DATA.alunos.slice().filter(a=>{
        const okAluno = !fAluno || ((a.nome||'').toLowerCase().includes(fAluno));
        // restringe por turma visível
        const turmaMatch = turmas.some(t=>matchTurmaAluno(t, a));
        return okAluno && turmaMatch;
      });

      const ocorr = DATA.ocorrencias.slice();

      // agregações
      const mapAlunosPorTurma = countAlunosPorTurma(alunos, turmas);
      const mapOcorrPorAluno  = countOcorrPorAluno(ocorr);
      const mapOcorrPorTurma  = countOcorrPorTurma(ocorr, alunos);

      // KPIs
      renderKPIs(alunos, turmas, ocorr);

      // Tabelas
      renderTabelaTurmas(turmas, mapAlunosPorTurma, mapOcorrPorTurma);
      renderTabelaAlunos(alunos, mapOcorrPorAluno);

      // Distribuição por escola integrada
      renderDistribuicaoEscola(alunos);
    }

    function matchTurmaAluno(turma, aluno){
      // Tente por turma_id; se não houver, usa rótulo textual "turma"
      if (aluno.turma_id != null && turma.id != null){
        return Number(aluno.turma_id) === Number(turma.id);
      }
      const rotAluno = (aluno.turma||'').trim().toLowerCase();
      const rotTurma = (turma.nome||'').trim().toLowerCase();
      return !!rotAluno && rotAluno === rotTurma;
    }

    function countAlunosPorTurma(alunos, turmas){
      const map = new Map();
      turmas.forEach(t=>map.set(t.id, 0));

      alunos.forEach(a=>{
        const turma = turmas.find(t=>matchTurmaAluno(t, a));
        if (turma) map.set(turma.id, (map.get(turma.id)||0)+1);
      });
      return map; // key: turma.id -> qtd
    }

    function countOcorrPorAluno(ocorr){
      const map = new Map();
      ocorr.forEach(o=>{
        const id = o.aluno_id;
        map.set(id, (map.get(id)||0)+1);
      });
      return map;
    }

    function countOcorrPorTurma(ocorr, alunos){
      const byAluno = countOcorrPorAluno(ocorr);
      const map = new Map();
      alunos.forEach(a=>{
        const qtd = byAluno.get(a.id)||0;
        // necessidade de turma
        const tKey = a.turma_id ?? (a.turma||'__rot_turma__'+(a.turma||''));
        map.set(tKey, (map.get(tKey)||0)+qtd);
      });
      return map; // key: turma_id (ou fallback textual) -> qtd
    }

    function mediaIdade(alunos){
      const nums = alunos.map(a=>Number(a.idade)).filter(n=>!isNaN(n) && n>0);
      if (!nums.length) return 0;
      return nums.reduce((s,n)=>s+n,0)/nums.length;
    }

    function renderKPIs(alunos, turmas, ocorr){
      el('#kpiTotalAlunos').textContent = alunos.length;
      const pcd = alunos.filter(a=>{
        const v = (a.pessoa_com_deficiencia ?? a.pcd ?? false);
        if (typeof v === 'string') return v.toLowerCase() === 'sim' || v.toLowerCase() === 'true';
        return !!v;
      }).length;
      el('#kpiPCD').textContent = pcd;

      const med = mediaIdade(alunos);
      el('#kpiMediaIdade').textContent = med ? med.toFixed(1).replace('.',',') : '-';

      const ativas = turmas.filter(t=>t.ativa===true).length;
      const fin    = turmas.filter(t=>t.ativa===false).length;
      el('#kpiTurmasAtivas').textContent = ativas;
      el('#kpiTurmasFinalizadas').textContent = fin;

      el('#kpiOcorrencias').textContent = (DATA.ocorrencias||[]).length;
    }

    function renderTabelaTurmas(turmas, mapAlunosPorTurma, mapOcorrPorTurma){
      const tbody = el('#tblTurmas tbody');
      if (!turmas.length){
        tbody.innerHTML = `<tr><td colspan="9" class="muted">Sem resultados.</td></tr>`;
        return;
      }
      const rows = turmas.map(t=>{
        const alunosQtd = mapAlunosPorTurma.get(t.id) || 0;

        // ocorrências por turma: tentar por id; se não achar, tenta por rótulo textual
        let ocorrQtd = mapOcorrPorTurma.get(t.id);
        if (ocorrQtd == null) ocorrQtd = mapOcorrPorTurma.get('__rot_turma__'+(t.nome||'')) || 0;

        const statusPill = t.ativa
          ? `<span class="pill green">Ativa</span>`
          : `<span class="pill gray">Finalizada</span>`;

        return `
          <tr>
            <td>${t.id ?? '-'}</td>
            <td>${t.nome ?? '-'}</td>
            <td>${t.curso_nome ?? '-'}</td>
            <td>${t.semestre ?? '-'}</td>
            <td>${t.data_inicio ?? '-'}</td>
            <td>${t.data_fim ?? '-'}</td>
            <td>${statusPill}</td>
            <td>${alunosQtd}</td>
            <td>${ocorrQtd}</td>
          </tr>
        `;
      }).join('');
      tbody.innerHTML = rows;

      // Export CSV
      el('#exportTurmas').onclick = ()=>{
        const data = [['ID','Turma','Curso','Semestre','Inicio','Termino','Status','Alunos','Ocorrencias']];
        turmas.forEach(t=>{
          const alunosQtd = mapAlunosPorTurma.get(t.id) || 0;
          let ocorrQtd = mapOcorrPorTurma.get(t.id);
          if (ocorrQtd == null) ocorrQtd = mapOcorrPorTurma.get('__rot_turma__'+(t.nome||'')) || 0;
          data.push([
            t.id??'', t.nome??'', t.curso_nome??'', t.semestre??'',
            t.data_inicio??'', t.data_fim??'',
            t.ativa?'Ativa':'Finalizada',
            alunosQtd, ocorrQtd
          ]);
        });
        download('turmas_resumo.csv', toCSV(data));
      };
    }

    function renderTabelaAlunos(alunos, mapOcorrPorAluno){
      const tbody = el('#tblAlunos tbody');
      if (!alunos.length){
        tbody.innerHTML = `<tr><td colspan="8" class="muted">Sem resultados.</td></tr>`;
        return;
      }
      const rows = alunos.map(a=>{
        const ocorr = mapOcorrPorAluno.get(a.id)||0;
        const curso = a.curso ?? a.curso_nome ?? '-';
        const escola = a.escola_integrada ?? a.escola ?? '-';
        const pcd = (a.pessoa_com_deficiencia ?? a.pcd ?? false);
        const pcdTxt = (typeof pcd === 'string') ? pcd : (pcd ? 'Sim' : 'Não');

        return `
          <tr>
            <td>${a.id ?? '-'}</td>
            <td>${(a.nome ?? '-')}</td>
            <td>${(a.turma ?? '-')}</td>
            <td>${curso}</td>
            <td>${a.idade ?? '-'}</td>
            <td>${escola}</td>
            <td>${pcdTxt}</td>
            <td>${ocorr}</td>
          </tr>
        `;
      }).join('');
      tbody.innerHTML = rows;

      // Export CSV
      el('#exportAlunos').onclick = ()=>{
        const data = [['ID','Aluno','Turma','Curso','Idade','Escola Integrada','PCD','Ocorrencias']];
        alunos.forEach(a=>{
          const ocorr = mapOcorrPorAluno.get(a.id)||0;
          const curso = a.curso ?? a.curso_nome ?? '';
          const escola = a.escola_integrada ?? a.escola ?? '';
          const pcd = (a.pessoa_com_deficiencia ?? a.pcd ?? false);
          const pcdTxt = (typeof pcd === 'string') ? pcd : (pcd ? 'Sim' : 'Não');
          data.push([a.id??'', a.nome??'', a.turma??'', curso, a.idade??'', escola, pcdTxt, ocorr]);
        });
        download('alunos_resumo.csv', toCSV(data));
      };
    }

    function renderDistribuicaoEscola(alunos){
      const tbody = el('#tblEscola tbody');
      if (!alunos.length){
        tbody.innerHTML = `<tr><td colspan="3" class="muted">Sem resultados.</td></tr>`;
        return;
      }
      const total = alunos.length;
      const mapa = new Map();
      alunos.forEach(a=>{
        const key = (a.escola_integrada ?? a.escola ?? 'Não informado') || 'Não informado';
        mapa.set(key, (mapa.get(key)||0)+1);
      });
      const linhas = [...mapa.entries()]
        .sort((a,b)=>b[1]-a[1])
        .map(([nome,qtd])=>{
          const pct = total? ((qtd/total)*100).toFixed(1).replace('.',',') : '0,0';
          return `<tr><td>${nome}</td><td>${qtd}</td><td>${pct}%</td></tr>`;
        }).join('');
      tbody.innerHTML = linhas || `<tr><td colspan="3" class="muted">Sem dados.</td></tr>`;
    }

    // Init
    loadAll();
  </script>
</body>
</html>
